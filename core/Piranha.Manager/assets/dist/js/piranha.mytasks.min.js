piranha.mytasks=new function(){"use strict";var e=this;e.load=function(){e.init()},e.init=function(){document.getElementById("mytasks")&&new Vue({el:"#mytasks",data:{loading:!0,items:[],state:"all",pendingAction:null,selectedTask:null,actionData:{comments:"",reason:""},executingAction:!1,actionError:null,approvalWorkflowData:null,approvalAccessibleStages:[],selectedApproveTargetStage:null,approveComments:"",approveTargetStageError:null,submittingApproveChangeRequest:!1,rejectReason:"",rejectReasonError:null,submittingRejectChangeRequest:!1},computed:{filteredItems:function(){var e=this;return this.items.filter((function(t){return"all"===e.state||("pending"===e.state?"Pending"===t.status||"Draft"===t.status||"InReview"===t.status:("approved"===e.state||e.state,!0))}))}},mounted:function(){this.loadTasks()},methods:{loadTasks:function(){var e=this;e.loading=!0;var t=piranha.baseUrl+"manager/api/mytasks";"all"!==e.state&&(t+="?filter="+encodeURIComponent(e.state)),fetch(t,{method:"GET",headers:{"Content-Type":"application/json"}}).then((function(e){if(!e.ok)throw new Error("Failed to load my tasks data");return e.json()})).then((function(t){var a=t.tasks;Array.isArray(a)||(a=Object.values(a||{}));var n=a.map((function(e,t){return{id:e.id,contentTitle:e.contentTitle,contentType:e.contentType,workflowName:e.workflowName,currentStage:e.currentStage,status:e.status,created:e.timestamp,notes:e.notes,availableActions:e.availableActions||[],editUrl:e.editUrl,transitionPath:e.transitionPath,acceptanceTime:e.acceptanceTime}}));e.items=n,e.loading=!1})).catch((function(t){console.error("Error loading my tasks:",t),piranha.notifications.push({type:"error",body:t.message||"Failed to load my tasks"}),e.loading=!1}))},setStatus:function(e){this.state=e,this.loadTasks()},canEdit:function(e){return e.availableActions&&e.availableActions.includes("edit")},canView:function(e){return e.availableActions&&e.availableActions.includes("view")},canApprove:function(e){return e.availableActions&&e.availableActions.includes("approve")},canReject:function(e){return e.availableActions&&e.availableActions.includes("reject")},getEditButtonText:function(e){return"Draft"===e.status?"Edit":"View"},getEditButtonIcon:function(e){return"Draft"===e.status?"fas fa-edit":"fas fa-eye"},approveTask:function(e){var t=this;fetch(piranha.baseUrl+"manager/api/changerequest/"+e.id+"/details",{method:"GET",headers:{"Content-Type":"application/json"}}).then((function(e){if(!e.ok)throw new Error("Failed to load workflow details");return e.json()})).then((function(a){var n=a.workflow,o=a.currentStage,i=n&&n.relations?n.relations:[],r=n&&n.stages?n.stages:[],s=i.filter((function(e){return e.sourceStageId===o.id})).map((function(e){return e.targetStageId})),c=r.filter((function(e){return-1!==s.indexOf(e.id)}));t.approvalWorkflowData=n,t.approvalAccessibleStages=c,t.selectedApproveTargetStage="",t.selectedTask=e,t.approveComments="",t.approveTargetStageError=null,t.submittingApproveChangeRequest=!1,$("#approveChangeRequestModal").modal("show"),$("#approveChangeRequestModal").on("shown.bs.modal",(function(){t.$nextTick((()=>{t.initApprovalDiagram()}))}))})).catch((function(e){piranha.notifications.push({type:"error",body:e.message||"Failed to load workflow details"})}))},rejectTask:function(e){var t=this;t.selectedTask=e,t.rejectReason="",t.rejectReasonError=null,t.submittingRejectChangeRequest=!1,$("#rejectChangeRequestModal").modal("show")},executeAction:function(e,t){this.pendingAction=null,this.selectedTask=null,this.actionData={comments:"",reason:""},this.actionError=null,this.executingAction=!1;var a=this;this.$nextTick((function(){a.pendingAction=e,a.selectedTask=t,$("#actionConfirmationModal").modal("show")}))},confirmAction:function(){var e=this;if("reject"!==e.pendingAction.type||e.actionData.reason.trim()){e.executingAction=!0,e.actionError=null;var t="",a={};"approve"===e.pendingAction.type?(t="approve",e.actionData.comments&&(a.comments=e.actionData.comments)):"reject"===e.pendingAction.type&&(t="reject",a.reason=e.actionData.reason),fetch(piranha.baseUrl+"manager/api/mytasks/"+e.selectedTask.id+"/"+t,{method:"POST",headers:{"Content-Type":"application/json",...piranha.utils.antiForgeryHeaders()},credentials:"same-origin",body:JSON.stringify(a)}).then((function(e){if(!e.ok)throw new Error("Failed to execute action");return e.json()})).then((function(t){e.executingAction=!1,$("#actionConfirmationModal").modal("hide"),piranha.notifications.push({type:"success",body:"Task "+e.pendingAction.type+"d successfully"}),e.loadTasks()})).catch((function(t){e.executingAction=!1,e.actionError=t.message||"Failed to execute action.",piranha.notifications.push({type:"error",body:e.actionError})}))}else e.actionError="Rejection reason is required."},cancelAction:function(){this.pendingAction=null,this.selectedTask=null,this.actionData={comments:"",reason:""},this.actionError=null,this.executingAction=!1,$("#actionConfirmationModal").modal("hide")},submitApproveChangeRequest:function(){var e=this;if(e.selectedApproveTargetStage){e.submittingApproveChangeRequest=!0;var t={comments:e.approveComments,nextStageId:e.selectedApproveTargetStage};fetch(piranha.baseUrl+"manager/api/mytasks/"+e.selectedTask.id+"/approve",{method:"POST",headers:{"Content-Type":"application/json",...piranha.utils.antiForgeryHeaders()},credentials:"same-origin",body:JSON.stringify(t)}).then((function(e){if(!e.ok)throw new Error("Failed to approve task");return e.json()})).then((function(t){e.submittingApproveChangeRequest=!1,$("#approveChangeRequestModal").modal("hide"),piranha.notifications.push({type:"success",body:"Task approved successfully"}),e.loadTasks()})).catch((function(t){e.submittingApproveChangeRequest=!1,e.approveTargetStageError=t.message||"Failed to approve task."}))}else e.approveTargetStageError="Please select a next stage."},submitRejectChangeRequest:function(){var e=this;if(e.rejectReason&&e.rejectReason.trim()){e.submittingRejectChangeRequest=!0;var t={reason:e.rejectReason};fetch(piranha.baseUrl+"manager/api/mytasks/"+e.selectedTask.id+"/reject",{method:"POST",headers:{"Content-Type":"application/json",...piranha.utils.antiForgeryHeaders()},credentials:"same-origin",body:JSON.stringify(t)}).then((function(e){if(!e.ok)throw new Error("Failed to reject task");return e.json()})).then((function(t){e.submittingRejectChangeRequest=!1,$("#rejectChangeRequestModal").modal("hide"),piranha.notifications.push({type:"success",body:"Task rejected successfully"}),e.loadTasks()})).catch((function(t){e.submittingRejectChangeRequest=!1,e.rejectReasonError=t.message||"Failed to reject task."}))}else e.rejectReasonError="Rejection reason is required."},formatDate:function(e){if(!e)return"";var t=new Date(e);return t.toLocaleDateString()+" "+t.toLocaleTimeString()},getStatusBadgeClass:function(e){switch(e){case"InReview":return"badge-warning";case"Published":return"badge-success";case"Rejected":return"badge-danger";default:return"badge-secondary"}},refreshTasks:function(){this.loadTasks()},getTransitionPath:function(e){return e.transitionPath?e.transitionPath.replace(/→/g," → "):"No path"},getAcceptanceTime:function(e){return null!=e.acceptanceTime?e.acceptanceTime.toFixed(2)+" hrs":"N/A"},initApprovalDiagram:function(){if(this.approvalWorkflowData&&this.approvalWorkflowData.stages&&0!==this.approvalWorkflowData.stages.length)if("undefined"!=typeof go){var e=document.getElementById("approveWorkflowDiagram");if(e){var t=go.GraphObject.make,a=t(go.Diagram,e,{layout:t(go.LayeredDigraphLayout,{direction:0,layerSpacing:50,columnSpacing:30}),isReadOnly:!0,allowSelect:!1,allowCopy:!1,allowDelete:!1,allowMove:!1,hasHorizontalScrollbar:!1,hasVerticalScrollbar:!1});a.nodeTemplate=t(go.Node,"Auto",t(go.Panel,"Table",{defaultAlignment:go.Spot.Left,margin:0},t(go.Shape,"Rectangle",{row:0,column:0,width:12,stretch:go.GraphObject.Vertical,fill:"#cccccc",stroke:null,minSize:new go.Size(12,40),maxSize:new go.Size(12,NaN),margin:0,parameter1:0,geometryString:"F M12,0 Q0,0 0,8 V72 Q0,80 12,80 H12 V0 Z"},new go.Binding("fill","color")),t(go.Panel,"Auto",{row:0,column:1},t(go.Shape,"Rectangle",{fill:"white",stroke:"#BBB",strokeWidth:1,minSize:new go.Size(120,40),parameter1:0,geometryString:"F M0,0 H108 Q120,0 120,8 V72 Q120,80 108,80 H0 Q0,80 0,72 V8 Q0,0 0,0 Z"}),t(go.Panel,"Vertical",{margin:10,defaultAlignment:go.Spot.Left},t(go.TextBlock,{font:"bold 10pt sans-serif",stroke:"#333",margin:new go.Margin(0,0,4,0)},new go.Binding("text","title")),t(go.TextBlock,{font:"9pt sans-serif",stroke:"#555",wrap:go.TextBlock.WrapDesiredSize,width:130},new go.Binding("text","description",(function(e){return e&&e.length>50?e.substring(0,47)+"...":e||""})))))),{locationSpot:go.Spot.Center}),a.linkTemplate=t(go.Link,{routing:go.Link.AvoidsNodes,corner:10},t(go.Shape,{strokeWidth:2,stroke:"#555"}),t(go.Shape,{toArrow:"Standard",fill:"#555",stroke:null}));var n=this.approvalWorkflowData.stages.map((function(e){return{key:e.id,title:e.title,description:e.description||"",color:e.color||"#cccccc"}})),o=(this.approvalWorkflowData.relations||[]).map((function(e){return{from:e.sourceStageId,to:e.targetStageId}}));a.model=new go.GraphLinksModel(n,o),a.requestUpdate()}else console.error("Approval diagram container not found")}else console.error("GoJS library not found for approval diagram")}},updated:function(){}})}};