piranha.pageedit=new Vue({el:"#pageedit",data:{loading:!0,id:null,siteId:null,parentId:null,originalId:null,sortOrder:0,typeId:null,title:null,navigationTitle:null,slug:null,metaTitle:null,metaKeywords:null,metaDescription:null,metaIndex:null,metaFollow:null,metaPriority:null,ogTitle:null,ogDescription:null,ogImage:{id:null,media:null},excerpt:null,isHidden:!1,published:null,publishedTime:null,redirectUrl:null,redirectType:null,enableComments:null,closeCommentsAfterDays:null,commentCount:null,pendingCommentCount:0,state:"new",blocks:[],regions:[],editors:[],useBlocks:!0,usePrimaryImage:!0,useExcerpt:!0,useHtmlExcerpt:!0,permissions:[],primaryImage:{id:null,media:null},selectedPermissions:[],isCopy:!1,isScheduled:!1,saving:!1,savingDraft:!1,selectedRegion:{uid:"uid-blocks",name:null,icon:null},selectedSetting:"uid-settings",selectedRoute:null,routes:[],changeRequestTitle:"",changeRequestNotes:"",changeRequestTitleError:null,submittingChangeRequest:!1,firstSaveChangeRequestTitle:"",firstSaveChangeRequestNotes:"",firstSaveChangeRequestTitleError:null,submittingFirstSaveChangeRequest:!1,pendingFirstSave:!1,pendingFirstSaveData:null,workflowData:null,accessibleStages:[],selectedTargetStage:"",targetStageError:null,loadingWorkflow:!1,workflowDiagram:null,changeRequests:[],selectedChangeRequestId:null,loadingChangeRequests:!1,isEditingChangeRequest:!1},computed:{contentRegions:function(){return this.regions.filter((function(e){return"setting"!=e.meta.display&&"hidden"!=e.meta.display}))},settingRegions:function(){return this.regions.filter((function(e){return"setting"===e.meta.display}))},primaryImageUrl:function(){return null!=this.primaryImage.media?piranha.utils.formatUrl("~/manager/api/media/url/"+this.primaryImage.id+"/448/200"):piranha.utils.formatUrl("~/manager/assets/img/empty-image.png")},isExcerptEmpty:function(){return piranha.utils.isEmptyText(this.excerpt)},metaPriorityDescription:function(){var e=piranha.resources.texts.important;return this.metaPriority<=.3?e=piranha.resources.texts.low:this.metaPriority<=.6?e=piranha.resources.texts.medium:this.metaPriority<=.9&&(e=piranha.resources.texts.high),e+" ("+this.metaPriority+")"},isChangeRequestReadOnly:function(){if(!this.isEditingChangeRequest||!this.selectedChangeRequestId)return!1;var e=this.changeRequests.find(function(e){return e.id===this.selectedChangeRequestId}.bind(this));return!!e&&0!==e.status}},mounted(){document.addEventListener("keydown",this.doHotKeys)},beforeDestroy(){document.removeEventListener("keydown",this.doHotKeys)},methods:{bind:function(e){this.id=e.id,this.siteId=e.siteId,this.parentId=e.parentId,this.originalId=e.originalId,this.sortOrder=e.sortOrder,this.typeId=e.typeId,this.title=e.title,this.navigationTitle=e.navigationTitle,this.slug=e.slug,this.metaTitle=e.metaTitle,this.metaKeywords=e.metaKeywords,this.metaDescription=e.metaDescription,this.metaIndex=e.metaIndex,this.metaFollow=e.metaFollow,this.metaPriority=e.metaPriority,this.ogTitle=e.ogTitle,this.ogDescription=e.ogDescription,this.ogImage=e.ogImage,this.excerpt=e.excerpt,this.isHidden=e.isHidden,this.published=e.published,this.publishedTime=e.publishedTime,this.redirectUrl=e.redirectUrl,this.redirectType=e.redirectType,this.enableComments=e.enableComments,this.closeCommentsAfterDays=e.closeCommentsAfterDays,this.commentCount=e.commentCount,this.pendingCommentCount=e.pendingCommentCount,this.state=e.state,this.blocks=e.blocks,this.regions=e.regions,this.editors=e.editors,this.useBlocks=e.useBlocks,this.usePrimaryImage=e.usePrimaryImage,this.useExcerpt=e.useExcerpt,this.useHtmlExcerpt=e.useHtmlExcerpt,this.isCopy=e.isCopy,this.isScheduled=e.isScheduled,this.selectedRoute=e.selectedRoute,this.routes=e.routes,this.permissions=e.permissions,this.primaryImage=e.primaryImage,this.selectedPermissions=e.selectedPermissions,this.useBlocks?this.selectedRegion={uid:"uid-blocks",name:null,icon:null}:this.editors.length>0?this.selectedRegion=this.editors[0]:this.contentRegions.length>0&&(this.selectedRegion=this.contentRegions[0].meta)},load:function(e){var t=this;fetch(piranha.baseUrl+"manager/api/page/"+e).then((function(e){return e.json()})).then((function(e){t.bind(e),t.id&&"new"!==t.state&&t.loadChangeRequests()})).catch((function(e){console.log("error:",e)}))},create:function(e,t){var i=this;fetch(piranha.baseUrl+"manager/api/page/create/"+e+"/"+t).then((function(e){return e.json()})).then((function(e){i.bind(e)})).catch((function(e){console.log("error:",e)}))},createrelative:function(e,t,i){var n=this;fetch(piranha.baseUrl+"manager/api/page/createrelative/"+e+"/"+t+"/"+i).then((function(e){return e.json()})).then((function(e){n.bind(e)})).catch((function(e){console.log("error:",e)}))},copy:function(e,t){var i=this;fetch(piranha.baseUrl+"manager/api/page/copy/"+e+"/"+t).then((function(e){return e.json()})).then((function(e){i.bind(e)})).catch((function(e){console.log("error:",e)}))},copyrelative:function(e,t,i){var n=this;fetch(piranha.baseUrl+"manager/api/page/copyrelative/"+e+"/"+t+"/"+i).then((function(e){return e.json()})).then((function(e){n.bind(e)})).catch((function(e){console.log("error:",e)}))},doHotKeys(e){83===e.keyCode&&e.ctrlKey&&(e.preventDefault(),this.saveDraft())},save:function(){this.saving=!0,this.saveInternal(piranha.baseUrl+"manager/api/page/save")},saveDraft:function(){this.isEditingChangeRequest&&this.selectedChangeRequestId?this.updateChangeRequest():this.openFirstSaveChangeRequestModal()},unpublish:function(){this.saving=!0,this.saveInternal(piranha.baseUrl+"manager/api/page/save/unpublish")},saveInternal:function(e){var t=this,i={id:t.id,siteId:t.siteId,parentId:t.parentId,originalId:t.originalId,sortOrder:t.sortOrder,typeId:t.typeId,title:t.title,navigationTitle:t.navigationTitle,slug:t.slug,metaTitle:t.metaTitle,metaKeywords:t.metaKeywords,metaDescription:t.metaDescription,metaIndex:t.metaIndex,metaFollow:t.metaFollow,metaPriority:t.metaPriority,ogTitle:t.ogTitle,ogDescription:t.ogDescription,ogImage:{id:t.ogImage.id},excerpt:t.excerpt,isHidden:t.isHidden,published:t.published,publishedTime:t.publishedTime,redirectUrl:t.redirectUrl,redirectType:t.redirectType,enableComments:t.enableComments,closeCommentsAfterDays:t.closeCommentsAfterDays,isCopy:t.isCopy,blocks:JSON.parse(JSON.stringify(t.blocks)),regions:JSON.parse(JSON.stringify(t.regions)),selectedRoute:t.selectedRoute,selectedPermissions:t.selectedPermissions,primaryImage:{id:t.primaryImage.id}};fetch(e,{method:"post",headers:piranha.utils.antiForgeryHeaders(),body:JSON.stringify(i)}).then((function(e){return e.json()})).then((function(e){var i=t.state;t.id=e.id,t.slug=e.slug,t.published=e.published,t.publishedTime=e.publishedTime,t.state=e.state,t.isCopy=e.isCopy,t.selectedRoute=e.selectedRoute,"new"===i&&"new"!==e.state&&(window.history.replaceState({state:"created"},"Edit page",piranha.baseUrl+"manager/page/edit/"+e.id),t.checkAndShowFirstSaveModal()),piranha.notifications.push(e.status),t.saving=!1,t.savingDraft=!1,t.eventBus.$emit("onSaved",t.state)})).catch((function(e){console.log("error:",e)}))},revert:function(){var e=this;fetch(piranha.baseUrl+"manager/api/page/revert",{method:"post",headers:piranha.utils.antiForgeryHeaders(),body:JSON.stringify(e.id)}).then((function(e){return e.json()})).then((function(t){e.bind(t),piranha.notifications.push(t.status)})).catch((function(e){console.log("error:",e)}))},detach:function(){var e=this;fetch(piranha.baseUrl+"manager/api/page/detach",{method:"post",headers:piranha.utils.antiForgeryHeaders(),body:JSON.stringify(e.id)}).then((function(e){return e.json()})).then((function(t){e.bind(t),piranha.notifications.push(t.status)})).catch((function(e){console.log("error:",e)}))},remove:function(){var e=this;piranha.alert.open({title:piranha.resources.texts.delete,body:piranha.resources.texts.deletePageConfirm,confirmCss:"btn-danger",confirmIcon:"fas fa-trash",confirmText:piranha.resources.texts.delete,onConfirm:function(){fetch(piranha.baseUrl+"manager/api/page/delete",{method:"delete",headers:piranha.utils.antiForgeryHeaders(),body:JSON.stringify(e.id)}).then((function(e){return e.json()})).then((function(e){piranha.notifications.push(e),window.location=piranha.baseUrl+"manager/pages"})).catch((function(e){console.log("error:",e)}))}})},addBlock:function(e,t){fetch(piranha.baseUrl+"manager/api/content/block/"+e).then((function(e){return e.json()})).then((function(e){piranha.pageedit.blocks.splice(t,0,e.body)})).catch((function(e){console.log("error:",e)}))},moveBlock:function(e,t){this.blocks.splice(t,0,this.blocks.splice(e,1)[0])},collapseBlock:function(e){e.meta.isCollapsed=!e.meta.isCollapsed},removeBlock:function(e){var t=this.blocks.indexOf(e);-1!==t&&this.blocks.splice(t,1)},updateBlockTitle:function(e){for(var t=0;t<this.blocks.length;t++)if(this.blocks[t].meta.uid===e.uid){this.blocks[t].meta.title=e.title;break}},selectRegion:function(e){this.selectedRegion=e,Vue.nextTick((function(){piranha.editor.refreshMarkdown()}))},selectSetting:function(e){this.selectedSetting=e,Vue.nextTick((function(){piranha.editor.refreshMarkdown()}))},isCommentsOpen:function(){var e=new Date(this.published+" "+this.publishedTime);return(e=e.addDays(this.closeCommentsAfterDays))>new Date},commentsClosedDate:function(){var e=new Date(this.published+" "+this.publishedTime);return(e=e.addDays(this.closeCommentsAfterDays)).toDateString()},selectPrimaryImage:function(){null!==this.primaryImage.media?piranha.mediapicker.open(this.updatePrimaryImage,"Image",this.primaryImage.media.folderId):piranha.mediapicker.openCurrentFolder(this.updatePrimaryImage,"Image")},removePrimaryImage:function(){this.primaryImage.id=null,this.primaryImage.media=null},updatePrimaryImage:function(e){"Image"===e.type?(this.primaryImage.id=e.id,this.primaryImage.media=e):console.log("No image was selected")},onExcerptBlur:function(e){this.useHtmlExcerpt?this.excerpt=tinyMCE.activeEditor.getContent():this.excerpt=e.target.innerHTML},openChangeRequestModal:function(){var e=this;if(this.changeRequestTitleError=null,this.targetStageError=null,this.submittingChangeRequest=!1,this.accessibleStages=[],this.workflowData=null,this.selectedChangeRequestId&&this.changeRequests.length>0){var t=this.changeRequests.find((function(t){return t.id===e.selectedChangeRequestId}));t?(this.changeRequestTitle=t.title||"",this.changeRequestNotes=t.notes||"",this.selectedTargetStage=t.stageId||""):(this.changeRequestTitle="",this.changeRequestNotes="",this.selectedTargetStage="")}else this.changeRequestTitle="",this.changeRequestNotes="",this.selectedTargetStage="";this.loadWorkflowData().then((()=>{$("#changeRequestModal").modal("show"),this.$nextTick((()=>{this.initChangeRequestDiagram()}))}))},submitChangeRequest:function(){var e=this;if(this.changeRequestTitleError=null,this.targetStageError=null,this.changeRequestTitle&&""!==this.changeRequestTitle.trim())if(this.selectedTargetStage){var t=window.changeRequestConfig?window.changeRequestConfig.workflowId:null,i=window.changeRequestConfig?window.changeRequestConfig.userId:null;if(t)if(i){var n=JSON.stringify({title:this.title,blocks:this.blocks,regions:this.regions,excerpt:this.excerpt});if(n&&"{}"!==n)if(this.submittingChangeRequest=!0,this.selectedChangeRequestId&&this.changeRequests.length>0){var a=this.changeRequests.find((function(t){return t.id===e.selectedChangeRequestId}));if(a){var s={Id:a.id,Title:this.changeRequestTitle.trim(),Notes:this.changeRequestNotes.trim(),ContentSnapshot:n,WorkflowId:a.workflowId,ContentId:a.contentId,StageId:this.selectedTargetStage,CreatedById:a.createdById,Status:a.status,CreatedAt:a.created,LastModified:(new Date).toISOString()};fetch(piranha.baseUrl+"manager/api/changerequest/save",{method:"POST",headers:{"Content-Type":"application/json",...piranha.utils.antiForgeryHeaders()},credentials:"same-origin",body:JSON.stringify(s)}).then((function(e){if(e.ok)return e.json();throw new Error("Failed to update change request")})).then((function(e){var t={UserId:a.createdById};return fetch(piranha.baseUrl+"manager/api/changerequest/"+a.id+"/submit",{method:"POST",headers:{"Content-Type":"application/json",...piranha.utils.antiForgeryHeaders()},credentials:"same-origin",body:JSON.stringify(t)})})).then((function(e){if(e.ok)return e.json();throw new Error("Failed to update change request")})).then((function(t){e.submittingChangeRequest=!1,$("#changeRequestModal").modal("hide"),a.title=e.changeRequestTitle.trim(),a.notes=e.changeRequestNotes.trim(),a.contentSnapshot=n,a.stageId=e.selectedTargetStage,a.status=1,piranha.notifications.push({body:"Change request submitted successfully",type:"success"}),e.loadChangeRequests()})).catch((function(t){e.submittingChangeRequest=!1,console.log("error:",t),piranha.notifications.push({body:"Failed to update change request. Please try again.",type:"danger"})}))}else this.submittingChangeRequest=!1,piranha.notifications.push({body:"Selected change request not found",type:"danger"})}else{var r={ContentId:this.id,Title:this.changeRequestTitle.trim(),Notes:this.changeRequestNotes.trim(),WorkflowId:t,CreatedById:i,TargetStageId:this.selectedTargetStage,ContentSnapshot:n};fetch(piranha.baseUrl+"manager/api/changerequest/create",{method:"POST",headers:{"Content-Type":"application/json",...piranha.utils.antiForgeryHeaders()},credentials:"same-origin",body:JSON.stringify(r)}).then((function(e){if(e.ok)return e.json();throw new Error("Failed to create change request")})).then((function(t){e.submittingChangeRequest=!1,$("#changeRequestModal").modal("hide"),e.savingDraft=!0,e.saveInternal(piranha.baseUrl+"manager/api/page/save/draft"),piranha.notifications.push({body:"Change request created successfully",type:"success"}),e.loadChangeRequests()})).catch((function(t){e.submittingChangeRequest=!1,console.log("error:",t),piranha.notifications.push({body:"Failed to create change request. Please try again.",type:"danger"})}))}else this.changeRequestTitleError="Content snapshot is required"}else this.changeRequestTitleError="User is required";else this.changeRequestTitleError="Workflow is required"}else this.targetStageError="Please select a target stage";else this.changeRequestTitleError="Title is required"},checkAndShowFirstSaveModal:function(){(window.changeRequestConfig?window.changeRequestConfig.workflowId:null)&&this.openFirstSaveChangeRequestModal()},openFirstSaveChangeRequestModal:function(){this.firstSaveChangeRequestTitle=this.title||"",this.firstSaveChangeRequestNotes="",this.firstSaveChangeRequestTitleError=null,this.submittingFirstSaveChangeRequest=!1,$("#firstSaveChangeRequestModal").modal("show")},submitFirstSaveChangeRequest:function(){var e=this;if(this.firstSaveChangeRequestTitleError=null,this.firstSaveChangeRequestTitle&&""!==this.firstSaveChangeRequestTitle.trim()){this.submittingFirstSaveChangeRequest=!0;var t=window.changeRequestConfig?window.changeRequestConfig.workflowId:null,i=window.changeRequestConfig?window.changeRequestConfig.userId:null;return t?i?void this.getDraftStageId(t).then((function(n){if(!n)return e.submittingFirstSaveChangeRequest=!1,void piranha.notifications.push({body:"Draft stage not found in workflow",type:"danger"});var a=JSON.stringify({title:e.title,blocks:e.blocks,regions:e.regions,excerpt:e.excerpt}),s={Title:e.firstSaveChangeRequestTitle.trim(),Notes:e.firstSaveChangeRequestNotes.trim(),ContentSnapshot:a,CreatedById:i,WorkflowId:t,TargetStageId:n,ContentId:e.id,ContentType:"Page"};fetch(piranha.baseUrl+"manager/api/changerequest/create",{method:"post",headers:piranha.utils.antiForgeryHeaders(),body:JSON.stringify(s)}).then((function(e){if(!e.ok)throw new Error("Failed to create change request");return e.json()})).then((function(t){e.submittingFirstSaveChangeRequest=!1,$("#firstSaveChangeRequestModal").modal("hide"),piranha.notifications.push({body:"Change request created successfully and placed in Draft stage",type:"success"}),e.savingDraft=!0,e.saveInternalWithReload(piranha.baseUrl+"manager/api/page/save/draft")})).catch((function(t){e.submittingFirstSaveChangeRequest=!1,console.log("error:",t),piranha.notifications.push({body:"Failed to create change request. Please try again.",type:"danger"})}))})).catch((function(t){e.submittingFirstSaveChangeRequest=!1,console.log("error getting draft stage:",t),piranha.notifications.push({body:"Failed to find Draft stage in workflow",type:"danger"})})):(this.submittingFirstSaveChangeRequest=!1,void piranha.notifications.push({body:"User configuration not found",type:"danger"})):(this.submittingFirstSaveChangeRequest=!1,void piranha.notifications.push({body:"No workflow configuration found",type:"danger"}))}this.firstSaveChangeRequestTitleError="Title is required"},getDraftStageId:function(e){return fetch(piranha.baseUrl+"manager/api/workflow/"+e).then((function(e){if(!e.ok)throw new Error("Failed to load workflow data");return e.json()})).then((function(e){var t=e.stages.find((function(e){return e.title&&"draft"===e.title.toLowerCase()}));return t?t.id:null}))},loadWorkflowData:function(){var e=this;return e.loadingWorkflow=!0,fetch(piranha.baseUrl+"manager/api/workflow/enabled").then((function(e){if(!e.ok)throw new Error("Failed to load workflow data");return e.json()})).then((function(t){e.workflowData=t,e.loadingWorkflow=!1,t&&t.stages&&t.relations&&e.filterAccessibleStages()})).catch((function(t){console.error("Error loading workflow data:",t),e.loadingWorkflow=!1,e.workflowData=null}))},filterAccessibleStages:function(){if(this.workflowData&&this.workflowData.stages&&this.workflowData.relations){var e=this.workflowData.stages.find((function(e){return e.title&&"draft"===e.title.toLowerCase()}));if(e){var t=new Set;(this.workflowData.relations||[]).forEach((function(i){i.sourceStageId===e.id&&t.add(i.targetStageId)})),this.accessibleStages=this.workflowData.stages.filter((function(e){return t.has(e.id)}))}else this.accessibleStages=this.workflowData.stages.slice()}else this.accessibleStages=[]},initChangeRequestDiagram:function(){if(this.workflowData&&this.workflowData.stages&&0!==this.workflowData.stages.length)if("undefined"!=typeof go){var e=document.getElementById("changeRequestWorkflowDiagram");if(e){this.workflowDiagram=go.GraphObject.make(go.Diagram,e,{layout:go.GraphObject.make(go.LayeredDigraphLayout,{direction:0,layerSpacing:50,columnSpacing:30}),isReadOnly:!0,allowSelect:!1,allowCopy:!1,allowDelete:!1,allowMove:!1,hasHorizontalScrollbar:!1,hasVerticalScrollbar:!1});var t=go.GraphObject.make;this.workflowDiagram.nodeTemplate=t(go.Node,"Auto",t(go.Panel,"Table",{defaultAlignment:go.Spot.Left,margin:0},t(go.Shape,"Rectangle",{row:0,column:0,width:12,stretch:go.GraphObject.Vertical,fill:"#cccccc",stroke:null,minSize:new go.Size(12,40),maxSize:new go.Size(12,NaN),margin:0,parameter1:0,geometryString:"F M12,0 Q0,0 0,8 V72 Q0,80 12,80 H12 V0 Z"},new go.Binding("fill","color")),t(go.Panel,"Auto",{row:0,column:1},t(go.Shape,"Rectangle",{fill:"white",stroke:"#BBB",strokeWidth:1,minSize:new go.Size(120,40),parameter1:0,geometryString:"F M0,0 H108 Q120,0 120,8 V72 Q120,80 108,80 H0 Q0,80 0,72 V8 Q0,0 0,0 Z"}),t(go.Panel,"Vertical",{margin:10,defaultAlignment:go.Spot.Left},t(go.TextBlock,{font:"bold 10pt sans-serif",stroke:"#333",margin:new go.Margin(0,0,4,0)},new go.Binding("text","title")),t(go.TextBlock,{font:"9pt sans-serif",stroke:"#555",wrap:go.TextBlock.WrapDesiredSize,width:130},new go.Binding("text","description",(function(e){return e&&e.length>50?e.substring(0,47)+"...":e||""})))))),{locationSpot:go.Spot.Center}),this.workflowDiagram.linkTemplate=go.GraphObject.make(go.Link,{routing:go.Link.AvoidsNodes,corner:10},go.GraphObject.make(go.Shape,{strokeWidth:2,stroke:"#555"}),go.GraphObject.make(go.Shape,{toArrow:"Standard",fill:"#555",stroke:null})),this.updateChangeRequestDiagram()}else console.error("Change request diagram container not found")}else console.error("GoJS library not found for change request diagram")},updateChangeRequestDiagram:function(){if(this.workflowDiagram&&this.workflowData){var e=this.workflowData.stages.map((function(e){return{key:e.id,title:e.title,description:e.description||"",color:e.color||"#cccccc"}})),t=(this.workflowData.relations||[]).map((function(e){return{from:e.sourceStageId,to:e.targetStageId}}));this.workflowDiagram.model=new go.GraphLinksModel(e,t),this.workflowDiagram.requestUpdate()}},loadChangeRequests:function(){var e=this;e.id&&null!==e.id&&(e.loadingChangeRequests=!0,fetch(piranha.baseUrl+"manager/api/changerequest/content/"+e.id).then((function(e){return e.json()})).then((function(t){e.changeRequests=t||[],e.loadingChangeRequests=!1,e.changeRequests.length>0&&(e.changeRequests.sort((function(e,t){return new Date(t.created)-new Date(e.created)})),e.selectedChangeRequestId=e.changeRequests[0].id,e.loadChangeRequestVersion(e.selectedChangeRequestId,!1))})).catch((function(t){console.log("Error loading change requests:",t),e.changeRequests=[],e.loadingChangeRequests=!1})))},switchVersion:function(){var e=this;e.loadingChangeRequests||(e.selectedChangeRequestId&&""!==e.selectedChangeRequestId?e.loadChangeRequestVersion(e.selectedChangeRequestId,!0):e.loadPublishedVersion())},loadPublishedVersion:function(){var e=this;e.isEditingChangeRequest=!1,fetch(piranha.baseUrl+"manager/api/page/"+e.id).then((function(e){return e.json()})).then((function(t){e.bind(t),piranha.notifications.push({body:"Switched to published version",type:"info"})})).catch((function(e){console.log("Error loading published version:",e),piranha.notifications.push({body:"Failed to load published version",type:"danger"})}))},loadChangeRequestVersion:function(e,t){t=!1!==t;var i=this;i.isEditingChangeRequest=!0;var n=i.changeRequests.find((function(t){return t.id===e}));if(!n)return piranha.notifications.push({body:"Change request not found",type:"danger"}),i.isEditingChangeRequest=!1,void(i.selectedChangeRequestId=null);try{if(!n.contentSnapshot||""===n.contentSnapshot.trim())return piranha.notifications.push({body:"Change request has no content snapshot. Staying on current version.",type:"warning"}),i.isEditingChangeRequest=!1,void(i.selectedChangeRequestId=null);var a;try{a=JSON.parse(n.contentSnapshot)}catch(e){var s=n.contentSnapshot.trim();return s.startsWith("{")||s.startsWith("[")?(console.log("Malformed JSON detected in change request:",e),piranha.notifications.push({body:"Change request contains corrupted data. Cannot load content.",type:"danger"}),i.isEditingChangeRequest=!1,void(i.selectedChangeRequestId=null)):(console.log("Legacy string content detected:",s),piranha.notifications.push({body:"Change request contains legacy text format. Full content preview not available.",type:"warning"}),i.isEditingChangeRequest=!1,void(i.selectedChangeRequestId=null))}void 0!==a.title&&(i.title=a.title),void 0!==a.blocks&&(i.blocks=a.blocks),void 0!==a.regions&&(i.regions=a.regions),void 0!==a.excerpt&&(i.excerpt=a.excerpt),t&&piranha.notifications.push({body:"Switched to change request: "+n.title,type:"info"})}catch(e){console.log("Unexpected error loading change request content:",e),piranha.notifications.push({body:"Failed to load change request content: "+e.message,type:"danger"}),i.isEditingChangeRequest=!1,i.selectedChangeRequestId=null}},formatStage:function(e){return e||"Unknown"},updateChangeRequest:function(){var e=this;if(e.selectedChangeRequestId){var t=e.changeRequests.find((function(t){return t.id===e.selectedChangeRequestId}));if(t){var i=JSON.stringify({title:e.title,blocks:e.blocks,regions:e.regions,excerpt:e.excerpt}),n={Id:t.id,Title:t.title,Notes:t.notes,ContentSnapshot:i,WorkflowId:t.workflowId,ContentId:t.contentId,StageId:t.stageId,CreatedById:t.createdById,Status:t.status,CreatedAt:t.created,LastModified:(new Date).toISOString()};e.savingDraft=!0,fetch(piranha.baseUrl+"manager/api/changerequest/save",{method:"POST",headers:{"Content-Type":"application/json",...piranha.utils.antiForgeryHeaders()},credentials:"same-origin",body:JSON.stringify(n)}).then((function(e){if(e.ok)return e.json();throw new Error("Failed to update change request")})).then((function(n){e.savingDraft=!1,t.contentSnapshot=i,piranha.notifications.push({body:"Change request updated successfully",type:"success"})})).catch((function(t){e.savingDraft=!1,console.log("Error updating change request:",t),piranha.notifications.push({body:"Failed to update change request. Please try again.",type:"danger"})}))}else piranha.notifications.push({body:"Change request not found",type:"danger"})}else piranha.notifications.push({body:"No change request selected to update",type:"danger"})},saveInternalWithReload:function(e){var t=this,i={id:t.id,siteId:t.siteId,parentId:t.parentId,originalId:t.originalId,sortOrder:t.sortOrder,typeId:t.typeId,title:t.title,navigationTitle:t.navigationTitle,slug:t.slug,metaTitle:t.metaTitle,metaKeywords:t.metaKeywords,metaDescription:t.metaDescription,metaIndex:t.metaIndex,metaFollow:t.metaFollow,metaPriority:t.metaPriority,ogTitle:t.ogTitle,ogDescription:t.ogDescription,ogImage:{id:t.ogImage.id},excerpt:t.excerpt,isHidden:t.isHidden,published:t.published,publishedTime:t.publishedTime,redirectUrl:t.redirectUrl,redirectType:t.redirectType,enableComments:t.enableComments,closeCommentsAfterDays:t.closeCommentsAfterDays,isCopy:t.isCopy,blocks:JSON.parse(JSON.stringify(t.blocks)),regions:JSON.parse(JSON.stringify(t.regions)),selectedRoute:t.selectedRoute,selectedPermissions:t.selectedPermissions,primaryImage:{id:t.primaryImage.id}};fetch(e,{method:"post",headers:piranha.utils.antiForgeryHeaders(),body:JSON.stringify(i)}).then((function(e){return e.json()})).then((function(e){t.saving=!1,t.savingDraft=!1,t.id=e.id,t.slug=e.slug,t.published=e.published,t.publishedTime=e.publishedTime,t.state=e.state,t.isCopy=e.isCopy,t.selectedRoute=e.selectedRoute,piranha.notifications.push(e.status),t.load(t.id)})).catch((function(e){console.log("error:",e),t.saving=!1,t.savingDraft=!1,piranha.notifications.push({body:"Failed to save page, but change request was created",type:"warning"}),t.load(t.id)}))}},created:function(){},updated:function(){this.loading?(sortable("#content-blocks",{handle:".handle",items:":not(.unsortable)"})[0].addEventListener("sortupdate",(function(e){piranha.pageedit.moveBlock(e.detail.origin.index,e.detail.destination.index)})),piranha.editor.addInline("excerpt-body","excerpt-toolbar")):(sortable("#content-blocks","disable"),sortable("#content-blocks","enable")),this.loading=!1},components:{datepicker:vuejsDatepicker}});