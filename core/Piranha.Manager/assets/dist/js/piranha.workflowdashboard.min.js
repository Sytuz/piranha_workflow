piranha.workflowdashboard=new function(){"use strict";var e=this;e.app=null,e.init=function(){document.getElementById("workflow-dashboard")&&(e.app=new Vue({el:"#workflow-dashboard",data:{loading:!0,error:null,activeTab:"overview",analyticsTimeRange:30,overview:null,analytics:null,changeHistory:null,loadingChanges:!1,changeFilters:{contentType:"",changeType:"",user:"",page:1,pageSize:20},changeHistoryDebounceTimeout:null,selectedWorkflowIdForStages:"all",allWorkflows:[],selectedChangeRequestId:null,changeRequestDetails:null,loadingDetails:!1,detailsError:null,pendingAction:null,actionData:{comments:"",reason:""},executingAction:!1,actionError:null,jsonFormatted:!1},computed:{maxStageCount:function(){return this.filteredStageDistribution&&0!==this.filteredStageDistribution.length?Math.max(...this.filteredStageDistribution.map((e=>e.count)),1):1},formattedContentSnapshot:function(){if(!this.changeRequestDetails||!this.changeRequestDetails.changeRequest.contentSnapshot)return"No content snapshot available";var e=this.changeRequestDetails.changeRequest.contentSnapshot;if(!e||""===e.trim())return"Content snapshot is empty";if(!this.jsonFormatted)return e;try{var t=JSON.parse(e);return JSON.stringify(t,null,2)}catch(t){return"// Unable to format as JSON - showing raw content:\n// Error: "+t.message+"\n\n"+e}},workflowOptionsForDistribution:function(){var e=[{value:"all",text:"All Workflows"}];return this.allWorkflows&&this.allWorkflows.length>0&&this.allWorkflows.forEach((function(t){e.push({value:t.id,text:t.title+(t.isEnabled?" (Active)":"")})})),e},filteredStageDistribution:function(){return this.overview&&this.overview.stageDistribution?"all"!==this.selectedWorkflowIdForStages&&this.selectedWorkflowIdForStages?this.overview.stageDistribution.filter((e=>e.workflowId===this.selectedWorkflowIdForStages)):this.overview.stageDistribution:[]}},mounted:function(){this.loadOverview()},methods:{setActiveTab:function(e){this.activeTab=e,"analytics"!==e||this.analytics?"changes"!==e||this.changeHistory||this.loadChangeHistory():this.loadAnalytics()},loadOverview:function(){var e=this;e.loading=!0,e.error=null,fetch(piranha.baseUrl+"manager/api/workflow-dashboard/overview",{method:"GET",headers:{"Content-Type":"application/json"}}).then((function(e){if(!e.ok)throw new Error("Failed to load overview data");return e.json()})).then((function(t){return e.overview=t,fetch(piranha.baseUrl+"manager/api/workflow/list")})).then((function(e){if(!e.ok)throw new Error("Failed to load workflow list");return e.json()})).then((function(t){if(e.allWorkflows=t,e.allWorkflows&&e.allWorkflows.length>0){const t=e.allWorkflows.find((e=>e.isEnabled));t?e.selectedWorkflowIdForStages=t.id:1===e.allWorkflows.length?e.selectedWorkflowIdForStages=e.allWorkflows[0].id:e.selectedWorkflowIdForStages="all"}else e.selectedWorkflowIdForStages="all";e.loading=!1})).catch((function(t){console.error("Error loading dashboard data:",t),e.error=t.message||"Failed to load dashboard data",e.loading=!1}))},loadAnalytics:function(){var e=this;e.loading=!0,e.error=null,fetch(piranha.baseUrl+"manager/api/workflow-dashboard/analytics?days="+e.analyticsTimeRange,{method:"GET",headers:{"Content-Type":"application/json"}}).then((function(e){if(!e.ok)throw new Error("Failed to load analytics data");return e.json()})).then((function(t){e.analytics=t,e.loading=!1,e.$nextTick((function(){e.initializeCharts()}))})).catch((function(t){console.error("Error loading analytics:",t),e.error=t.message||"Failed to load analytics",e.loading=!1}))},loadChangeHistory:function(){var e=this;e.loadingChanges=!0;var t=new URLSearchParams;e.changeFilters.contentType&&t.append("contentType",e.changeFilters.contentType),e.changeFilters.changeType&&t.append("changeType",e.changeFilters.changeType),e.changeFilters.user&&t.append("user",e.changeFilters.user),t.append("page",e.changeFilters.page),t.append("pageSize",e.changeFilters.pageSize),fetch(piranha.baseUrl+"manager/api/workflow-dashboard/changes?"+t.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((function(e){if(!e.ok)throw new Error("Failed to load change history");return e.json()})).then((function(t){e.changeHistory=t,e.loadingChanges=!1})).catch((function(t){console.error("Error loading change history:",t),e.error=t.message||"Failed to load change history",e.loadingChanges=!1}))},setAnalyticsTimeRange:function(e){this.analyticsTimeRange=e,this.loadAnalytics()},changeHistoryPage:function(e){e>=1&&e<=this.changeHistory.totalPages&&(this.changeFilters.page=e,this.loadChangeHistory())},clearChangeFilters:function(){this.changeFilters={contentType:"",changeType:"",user:"",page:1,pageSize:20},this.loadChangeHistory()},debounceLoadChangeHistory:function(){var e=this;e.changeHistoryDebounceTimeout&&clearTimeout(e.changeHistoryDebounceTimeout),e.changeHistoryDebounceTimeout=setTimeout((function(){e.changeFilters.page=1,e.loadChangeHistory()}),500)},refreshData:function(){"overview"===this.activeTab?this.loadOverview():"analytics"===this.activeTab?this.loadAnalytics():"changes"===this.activeTab&&this.loadChangeHistory()},viewChangeRequestDetails:function(e){this.selectedChangeRequestId=e,this.loadChangeRequestDetails(e),$("#changeRequestDetailsModal").modal("show")},loadChangeRequestDetails:function(e){var t=this;t.loadingDetails=!0,t.detailsError=null,t.changeRequestDetails=null,fetch(piranha.baseUrl+"manager/api/changerequest/"+e+"/details",{method:"GET",headers:{"Content-Type":"application/json"}}).then((function(e){if(!e.ok)throw new Error("Failed to load change request details");return e.json()})).then((function(e){t.changeRequestDetails=e,t.loadingDetails=!1})).catch((function(e){console.error("Error loading change request details:",e),t.detailsError=e.message||"Failed to load change request details",t.loadingDetails=!1}))},executeAction:function(e,t){this.pendingAction=e,this.selectedChangeRequestId=t,this.actionData={comments:"",reason:""},this.actionError=null,$("#actionConfirmationModal").modal("show")},confirmAction:function(){var e=this;if("reject"!==e.pendingAction.type||e.actionData.reason.trim()){e.executingAction=!0,e.actionError=null;var t="",a={userId:piranha.userId||"00000000-0000-0000-0000-000000000000"};"approve"===e.pendingAction.type?(t="approve",e.actionData.comments&&(a.comments=e.actionData.comments)):"reject"===e.pendingAction.type?(t="reject",a.reason=e.actionData.reason):"edit"===e.pendingAction.type&&(t="edit"),fetch(piranha.baseUrl+"manager/api/changerequest/"+e.selectedChangeRequestId+"/"+t,{method:"POST",headers:{"Content-Type":"application/json",...piranha.utils.antiForgeryHeaders()},credentials:"same-origin",body:JSON.stringify(a)}).then((function(e){if(!e.ok)throw new Error("Failed to execute action");return e.json()})).then((function(t){e.executingAction=!1,$("#actionConfirmationModal").modal("hide"),$("#changeRequestDetailsModal").modal("hide"),e.refreshData()})).catch((function(t){e.executingAction=!1,e.actionError=t.message||"Failed to execute action."}))}else e.actionError="Rejection reason is required."},getChangeStatusBadgeClass:function(e){switch(e){case 0:default:return"badge-secondary";case 1:return"badge-primary";case 2:return"badge-info";case 3:case 5:return"badge-success";case 4:return"badge-danger"}},getChangeStatusText:function(e){switch(e){case 0:return"Draft";case 1:return"Submitted";case 2:return"In Review";case 3:return"Approved";case 4:return"Rejected";case 5:return"Published";default:return"Unknown"}},getActionButtonClass:function(e){switch(e){case"approve":return"btn-success";case"reject":return"btn-danger";case"edit":return"btn-primary";case"move":return"btn-warning";default:return"btn-secondary"}},getStagePercentage:function(e){return 0===this.maxStageCount?0:e/this.maxStageCount*100},getBottleneckCount:function(){return this.analytics&&this.analytics.bottlenecks?this.analytics.bottlenecks.filter((e=>e.bottleneckSeverity>=2)).length:0},getCompletionRateBadgeClass:function(e){return e>=90?"badge-success":e>=70?"badge-warning":"badge-danger"},getContentTypeBadgeClass:function(e){return"Page"===e?"badge-primary":"badge-info"},getChangeTypeBadgeClass:function(e){switch(e.toLowerCase()){case"created":case"approved":return"badge-success";case"updated":return"badge-info";case"rejected":return"badge-danger";default:return"badge-secondary"}},getPageNumbers:function(){if(!this.changeHistory)return[];for(var e=this.changeHistory.totalPages,t=this.changeHistory.currentPage,a=[],n=Math.max(1,t-2),o=Math.min(e,n+4),i=n;i<=o;i++)a.push(i);return a},formatDateTime:function(e){return e?new Date(e).toLocaleString():""},toggleJsonFormatting:function(){this.jsonFormatted=!this.jsonFormatted,piranha.notifications.push({type:"info",body:this.jsonFormatted?"JSON formatted for readability":"Showing raw JSON content"})},copyContentSnapshot:function(){if(this.changeRequestDetails&&this.changeRequestDetails.changeRequest.contentSnapshot){var e=this.formattedContentSnapshot,t=this;navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then((function(){piranha.notifications.push({type:"success",body:"Content snapshot copied to clipboard!"})})).catch((function(a){console.error("Failed to copy text: ",a),t.fallbackCopyTextToClipboard(e)})):this.fallbackCopyTextToClipboard(e)}else piranha.notifications.push({type:"warning",body:"No content snapshot available to copy."})},fallbackCopyTextToClipboard:function(e){var t=document.createElement("textarea");t.value=e,t.style.top="0",t.style.left="0",t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy")?piranha.notifications.push({type:"success",body:"Content snapshot copied to clipboard!"}):piranha.notifications.push({type:"error",body:"Failed to copy content snapshot to clipboard."})}catch(e){console.error("Fallback: Oops, unable to copy",e),piranha.notifications.push({type:"error",body:"Copy to clipboard is not supported in this browser."})}document.body.removeChild(t)},initializeCharts:function(){if("undefined"!=typeof Chart&&this.analytics&&this.analytics.dailyStats){var e=document.getElementById("dailyActivityChart");if(e){this.dailyActivityChart&&this.dailyActivityChart.destroy();var t=this.analytics.dailyStats.map((function(e){return new Date(e.date).toLocaleDateString()})),a=this.analytics.dailyStats.map((function(e){return e.itemsCreated})),n=this.analytics.dailyStats.map((function(e){return e.itemsApproved})),o=this.analytics.dailyStats.map((function(e){return e.itemsCompleted}));this.dailyActivityChart=new Chart(e,{type:"line",data:{labels:t,datasets:[{label:"Created",data:a,borderColor:"rgb(54, 162, 235)",backgroundColor:"rgba(54, 162, 235, 0.1)",tension:.1},{label:"Approved",data:n,borderColor:"rgb(75, 192, 192)",backgroundColor:"rgba(75, 192, 192, 0.1)",tension:.1},{label:"Completed",data:o,borderColor:"rgb(255, 99, 132)",backgroundColor:"rgba(255, 99, 132, 0.1)",tension:.1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}},plugins:{legend:{position:"top"},title:{display:!0,text:"Daily Workflow Activity"}}}})}}}}}))}},$(document).ready((function(){piranha.workflowdashboard.init()}));