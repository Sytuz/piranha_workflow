void 0!==window.go&&console.warn("GoJS global object already defined. Skipping redefinition."),piranha.workflowedit=new Vue({el:"#workflowedit",data:{loading:!0,id:null,title:"",description:"",stages:[],availableRoles:[],relations:[],saveUrl:piranha.baseUrl+"manager/api/workflow/save",rolesUrl:piranha.baseUrl+"manager/api/workflow/roles",originalTitle:null,goJsDiagram:null,diagramInitialized:!1,initAttempts:0,maxInitAttempts:5},methods:{bind:function(t){this.id=t.id,this.title=t.title,this.originalTitle=t.title,this.description=t.description,this.stages=(t.stages||[]).map((function(t){return{id:t.id,title:t.title,description:t.description,sortOrder:t.sortOrder,color:t.color||"#cccccc",roleIds:(t.roles||[]).map((function(t){return t.roleId}))||[],isImmutable:!!t.isImmutable}})),this.relations=(t.relations||[]).map((function(t){return{sourceStageId:t.sourceStageId,targetStageId:t.targetStageId}})),this.loading=!1,this.$nextTick((()=>{this.attemptDiagramInitialization()}))},attemptDiagramInitialization:function(){if(this.diagramInitialized&&this.goJsDiagram)return console.log("GoJS: Diagram already initialized successfully"),void this.updateGoJsModel();if(this.initAttempts>=this.maxInitAttempts)return void console.warn("GoJS: Max initialization attempts reached. Please check for errors.");console.log(`GoJS: Initialization attempt ${this.initAttempts+1} of ${this.maxInitAttempts}`),this.initAttempts++;if(this.initGoJsDiagram()&&this.diagramInitialized&&this.goJsDiagram)console.log("GoJS: Initialization successful"),this.updateGoJsModel();else{const t=Math.min(1e3*Math.pow(1.5,this.initAttempts),5e3);console.log(`GoJS: Scheduling retry in ${t}ms`),setTimeout((()=>this.attemptDiagramInitialization()),t)}},initGoJsDiagram:function(){if(console.log("Initializing GoJS diagram..."),"undefined"==typeof go)return console.error("GoJS library is not loaded. Will try again later."),!1;let t=null;if(this.$refs&&this.$refs.workflowDiagramDiv)t=this.$refs.workflowDiagramDiv,console.log("GoJS: Found diagram div via Vue $refs");else{if(t=document.getElementById("workflowDiagramDiv"),!t)return console.error("GoJS: Diagram div element not found in DOM"),!1;console.log("GoJS: Found diagram div via getElementById")}if(this.goJsDiagram){console.log("GoJS: Cleaning up old diagram instance");try{this.goJsDiagram.div&&(this.goJsDiagram.div=null),this.goJsDiagram=null}catch(t){console.error("GoJS: Error cleaning up old diagram:",t)}}if(!t)return console.error("GoJS: No diagram div available after checks. Diagram initialization will fail."),!1;t.innerHTML="",t.style.height="400px",t.style.minHeight="400px",t.style.width="100%",t.style.position="relative",t.style.display="block",t.offsetHeight,console.log("GoJS: Creating new diagram instance. Div height:",t.offsetHeight);const i=go.GraphObject.make;try{return this.goJsDiagram=i(go.Diagram,t,{initialContentAlignment:go.Spot.Center,initialScale:.95,layout:i(go.LayeredDigraphLayout,{direction:0,layerSpacing:50,columnSpacing:30}),"undoManager.isEnabled":!1,"animationManager.isEnabled":!1,allowMove:!1,allowCopy:!1,allowDelete:!1,allowInsert:!1}),this.goJsDiagram.nodeTemplate=i(go.Node,"Auto",i(go.Panel,"Table",{defaultAlignment:go.Spot.Left,margin:0},i(go.Shape,"Rectangle",{row:0,column:0,width:12,stretch:go.GraphObject.Vertical,fill:"#cccccc",stroke:null,minSize:new go.Size(12,40),maxSize:new go.Size(12,NaN),margin:0,parameter1:0,geometryString:"F M0,0 H12 Q12,0 12,8 V72 Q12,80 0,80 H0 Q0,80 0,72 V8 Q0,0 0,0 Z"},new go.Binding("fill","color"),{geometryString:"F M12,0 Q0,0 0,8 V72 Q0,80 12,80 H12 V0 Z"}),i(go.Panel,"Auto",{row:0,column:1},i(go.Shape,"Rectangle",{fill:"white",stroke:"#BBB",strokeWidth:1,minSize:new go.Size(120,40),parameter1:0,geometryString:"F M0,0 H108 Q120,0 120,8 V72 Q120,80 108,80 H0 Q0,80 0,72 V8 Q0,0 0,0 Z"}),i(go.Panel,"Vertical",{margin:10,defaultAlignment:go.Spot.Left},i(go.TextBlock,{font:"bold 10pt sans-serif",stroke:"#333",margin:new go.Margin(0,0,4,0)},new go.Binding("text","title")),i(go.TextBlock,{font:"9pt sans-serif",stroke:"#555",wrap:go.TextBlock.WrapDesiredSize,width:130},new go.Binding("text","description",(function(t){return t?t.length>50?t.substring(0,50)+"...":t:""})))))),{toolTip:i(go.Adornment,"Auto",i(go.TextBlock,{margin:4},new go.Binding("text","description")))}),this.goJsDiagram.linkTemplate=i(go.Link,{routing:go.Link.AvoidsNodes,corner:10,curve:go.Link.JumpOver,reshapable:!1,resegmentable:!1,relinkableFrom:!1,relinkableTo:!1,selectionAdorned:!1},i(go.Shape,{strokeWidth:2,stroke:"#555"}),i(go.Shape,{toArrow:"Standard",fill:"#555",stroke:null,scale:1.5})),this.diagramInitialized=!0,console.log("GoJS: Diagram initialization complete"),!0}catch(t){return console.error("GoJS: Error during diagram initialization:",t),!1}},updateGoJsModel:function(){if(console.log("Updating GoJS model..."),"undefined"==typeof go)return console.error("GoJS: Library not loaded. Cannot update model."),!1;if(!(this.goJsDiagram&&this.diagramInitialized||(console.log("GoJS: Diagram not initialized yet, attempting initialization"),this.initAttempts=0,this.initGoJsDiagram())))return console.error("GoJS updateGoJsModel: Diagram initialization failed. Will retry later."),setTimeout((()=>this.attemptDiagramInitialization()),500),!1;if(!this.goJsDiagram)return console.error("GoJS updateGoJsModel: Diagram instance is not available. initGoJsDiagram might have failed or was not called when the div was ready."),!1;if(!this.stages||0===this.stages.length){console.log("GoJS: No stages to display, clearing diagram");try{const t=new go.GraphLinksModel([],[]);this.goJsDiagram.model=t,this.goJsDiagram.requestUpdate()}catch(t){console.error("GoJS: Error clearing diagram:",t)}return!0}try{console.log("GoJS: Diagram div element:",this.goJsDiagram.div),console.log("GoJS: Building node data array with",this.stages.length,"stages");const t=[];this.stages.forEach((i=>{i&&i.id?t.push({key:i.id,title:i.title||"Untitled stage",description:i.description||"",isPublished:!1,color:i.color||"#cccccc"}):console.warn("GoJS: Skipping invalid stage:",i)})),console.log("GoJS: Building link data array with",this.relations.length,"relations");const i=[];this.relations.forEach((t=>{t&&t.sourceStageId&&t.targetStageId?i.push({from:t.sourceStageId,to:t.targetStageId}):console.warn("GoJS: Skipping invalid relation:",t)})),console.log("GoJS: Setting model with",t.length,"nodes and",i.length,"links");const e=new go.GraphLinksModel;return e.nodeKeyProperty="key",e.linkFromKeyProperty="from",e.linkToKeyProperty="to",e.nodeDataArray=t,e.linkDataArray=i,this.goJsDiagram.model=e,this.goJsDiagram.requestUpdate(),this.goJsDiagram.layout&&(this.goJsDiagram.layout.invalidateLayout(),this.goJsDiagram.layoutDiagram()),!0}catch(t){return console.error("GoJS: Error updating model:",t),!1}},load:function(t){var i=this;t&&(i.id=t,fetch(piranha.baseUrl+"manager/api/workflow/"+t).then((function(t){if(!t.ok)throw new Error("Response status: "+t.status);return t.json()})).then((function(t){i.bind(t),i.initAttempts=0})).catch((function(t){console.log("Error loading workflow:",t),piranha.notifications.push({body:"Failed to load workflow. Please try again.",type:"danger",hide:!0})}))),fetch(this.rolesUrl).then((t=>t.json())).then((t=>{this.availableRoles=t})).catch((t=>{console.error("Error loading roles:",t)}))},create:function(){this.id=null,this.title="",this.description="",this.stages=[],this.relations=[],this.loading=!1,fetch(this.rolesUrl).then((t=>t.json())).then((t=>{this.availableRoles=t,this.$nextTick((()=>{this.initAttempts=0,this.attemptDiagramInitialization()}))})).catch((t=>{console.error("Error loading roles:",t)}))},save:function(){var t=this;if(""!==t.title)if(0!==t.stages.length){for(var i=0;i<t.stages.length;i++)if(!t.stages[i].title)return void piranha.notifications.push({body:"Please enter a title for all stages",type:"danger",hide:!0});t.loading=!0;var e={id:t.id,title:t.title,description:t.description,stages:t.stages.map((function(t,i){return{id:t.id,title:t.title,description:t.description,sortOrder:i+1,color:t.color||"#cccccc",roles:(t.roleIds||[]).map((function(t){return{roleId:t}}))}})),relations:t.relations.map((function(t){return{sourceStageId:t.sourceStageId,targetStageId:t.targetStageId}}))};fetch(t.saveUrl,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then((function(t){return t.ok?t.json():t.json().then((function(t){throw t}))})).then((function(i){t.id=i.id,t.originalTitle=i.title,piranha.notifications.push({body:"The workflow has been saved",type:"success",hide:!0}),t.loading=!1,e.id||(window.location=piranha.baseUrl+"manager/workflow/edit/"+i.id)})).catch((function(i){console.log("Error saving workflow:",i),piranha.notifications.push({body:i.body||"An error occurred while saving the workflow",type:"danger",hide:!0}),t.loading=!1}))}else piranha.notifications.push({body:"Please add at least one stage to the workflow",type:"danger",hide:!0});else piranha.notifications.push({body:"Please enter a title for the workflow",type:"danger",hide:!0})},addStage:function(){this.stages.length>0&&this.stages[this.stages.length-1].isImmutable?piranha.notifications.push({body:"You cannot add a stage after an immutable stage.",type:"danger",hide:!0}):(this.stages.push({id:piranha.utils.generateId(),title:"",description:"",sortOrder:this.stages.length+1,color:"#cccccc",roleIds:[],isImmutable:!1}),this.$nextTick((()=>{this.updateGoJsModel()})))},removeStage:function(t){console.log(this.stages);const i=this.stages[t];i.isImmutable?piranha.notifications.push({body:"This stage cannot be deleted.",type:"danger",hide:!0}):(this.stages.splice(t,1),this.relations=this.relations.filter((function(t){return t.sourceStageId!==i.id&&t.targetStageId!==i.id})),this.$nextTick((()=>{this.updateGoJsModel()})))},moveStageUp:function(t){if(t>0&&!this.stages[t].isImmutable&&!this.stages[t-1].isImmutable){const i=this.stages.splice(t,1)[0];this.stages.splice(t-1,0,i),this.$nextTick((()=>{this.updateGoJsModel()}))}},moveStageDown:function(t){if(t<this.stages.length-1&&!this.stages[t].isImmutable&&!this.stages[t+1].isImmutable){const i=this.stages.splice(t,1)[0];this.stages.splice(t+1,0,i),this.$nextTick((()=>{this.updateGoJsModel()}))}},getOtherStages:function(t){return this.stages.filter((function(i){return i.id!==t}))},canTransitionTo:function(t,i){return this.relations.some((function(e){return e.sourceStageId===t&&e.targetStageId===i}))},isRoleEditingDisabled:function(t){if(!t.isImmutable)return!1;return!(this.stages.length>0&&this.stages[0].id===t.id)},toggleStageRole:function(t,i,e){if(this.isRoleEditingDisabled(t)){e.preventDefault();var o=e.target,a=t.roleIds&&t.roleIds.includes(i);o.checked!==a&&(o.checked=a)}else e.target.checked?t.roleIds.includes(i)||t.roleIds.push(i):t.roleIds=t.roleIds.filter((function(t){return t!==i}))},selectAllRoles:function(t){if(!this.isRoleEditingDisabled(t)){this.availableRoles.forEach((function(i){t.roleIds.includes(i.id)||t.roleIds.push(i.id)}))}},deselectAllRoles:function(t){this.isRoleEditingDisabled(t)||(t.roleIds=[])},isRelationEditingDisabled:function(t){if(!t.isImmutable)return!1;return!(this.stages.length>0&&this.stages[0].id===t.id)},toggleStageRelation:function(t,i,e){const o=this.stages.find((i=>i.id===t));if(this.isRelationEditingDisabled(o)){e.preventDefault();var a=e.target,n=this.canTransitionTo(t,i);return a.checked!==n&&(a.checked=n),void piranha.notifications.push({body:"Relations for this immutable stage cannot be modified.",type:"warning",hide:!0})}e.target.checked?this.canTransitionTo(t,i)||this.relations.push({sourceStageId:t,targetStageId:i}):this.relations=this.relations.filter((function(e){return!(e.sourceStageId===t&&e.targetStageId===i)})),console.log("Relation toggled, updating diagram"),this.$nextTick((()=>{this.updateGoJsModel()}))},truncateDescription:function(t,i){return t?t.length>i?t.substring(0,i)+"...":t:""},onStageColorChange:function(t,i){t.isImmutable?i.preventDefault():(t.color=i.target.value,this.$nextTick((()=>{this.updateGoJsModel()})))}},computed:{hasStages:function(){return this.stages&&this.stages.length>0}},updated:function(){this.$nextTick((()=>{this.loading||this.diagramInitialized||!document.getElementById("workflowDiagramDiv")?this.diagramInitialized&&this.goJsDiagram&&(console.log("Vue updated hook: Diagram initialized, updating model"),this.updateGoJsModel()):(console.log("Vue updated hook: Initializing diagram"),this.attemptDiagramInitialization())}))},mounted:function(){console.log("Vue component mounted"),this.$nextTick((()=>{this.initAttempts=0,this.attemptDiagramInitialization()}))}});