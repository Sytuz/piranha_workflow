void 0!==window.go&&console.warn("GoJS global object already defined. Skipping redefinition."),piranha.workflowedit=new Vue({el:"#workflowedit",data:{loading:!0,id:null,title:"",description:"",isDefault:!1,stages:[],availableRoles:[],relations:[],saveUrl:piranha.baseUrl+"manager/api/workflow/save",rolesUrl:piranha.baseUrl+"manager/api/workflow/roles",originalTitle:null,diagramInitialized:!1,initAttempts:0,maxInitAttempts:5},methods:{bind:function(t){this.id=t.id,this.title=t.title,this.originalTitle=t.title,this.description=t.description,this.isDefault=t.isDefault||!1,this.stages=(t.stages||[]).map((function(t){const e=(t.roles||[]).map((function(t){const e=t.roleId||t.RoleId;return String(e).toUpperCase()}))||[];return{id:t.id,title:t.title,description:t.description,sortOrder:t.sortOrder,color:t.color||"#cccccc",roleIds:e,isImmutable:!!t.isImmutable}})),this.relations=(t.relations||[]).map((function(t){return{sourceStageId:t.sourceStageId,targetStageId:t.targetStageId}})),this.loading=!1,this.$nextTick((()=>{this.attemptDiagramInitialization()}))},attemptDiagramInitialization:function(){if(this.diagramInitialized&&this.goJsDiagram)return void this.updateGoJsModel();if(this.initAttempts>=this.maxInitAttempts)return;this.initAttempts++;if(this.initGoJsDiagram()&&this.diagramInitialized&&this.goJsDiagram)this.updateGoJsModel();else{const t=Math.min(1e3*Math.pow(1.5,this.initAttempts),5e3);setTimeout((()=>this.attemptDiagramInitialization()),t)}},initGoJsDiagram:function(){if("undefined"==typeof go)return!1;let t=null;if(this.$refs&&this.$refs.workflowDiagramDiv)t=this.$refs.workflowDiagramDiv;else if(t=document.getElementById("workflowDiagramDiv"),!t)return!1;if(this.goJsDiagram)try{this.goJsDiagram.div&&(this.goJsDiagram.div=null),this.goJsDiagram=null}catch(t){}if(!t)return!1;t.innerHTML="",t.style.height="400px",t.style.minHeight="400px",t.style.width="100%",t.style.position="relative",t.style.display="block",t.offsetHeight;const e=go.GraphObject.make;try{return this.goJsDiagram=e(go.Diagram,t,{initialContentAlignment:go.Spot.Center,initialScale:.95,layout:e(go.LayeredDigraphLayout,{direction:0,layerSpacing:50,columnSpacing:30}),"undoManager.isEnabled":!1,"animationManager.isEnabled":!1,allowMove:!1,allowCopy:!1,allowDelete:!1,allowInsert:!1}),this.goJsDiagram.nodeTemplate=e(go.Node,"Auto",e(go.Panel,"Table",{defaultAlignment:go.Spot.Left,margin:0},e(go.Shape,"Rectangle",{row:0,column:0,width:12,stretch:go.GraphObject.Vertical,fill:"#cccccc",stroke:null,minSize:new go.Size(12,40),maxSize:new go.Size(12,NaN),margin:0,parameter1:0,geometryString:"F M0,0 H12 Q12,0 12,8 V72 Q12,80 0,80 H0 Q0,80 0,72 V8 Q0,0 0,0 Z"},new go.Binding("fill","color"),{geometryString:"F M12,0 Q0,0 0,8 V72 Q0,80 12,80 H12 V0 Z"}),e(go.Panel,"Auto",{row:0,column:1},e(go.Shape,"Rectangle",{fill:"white",stroke:"#BBB",strokeWidth:1,minSize:new go.Size(120,40),parameter1:0,geometryString:"F M0,0 H108 Q120,0 120,8 V72 Q120,80 108,80 H0 Q0,80 0,72 V8 Q0,0 0,0 Z"}),e(go.Panel,"Vertical",{margin:10,defaultAlignment:go.Spot.Left},e(go.TextBlock,{font:"bold 10pt sans-serif",stroke:"#333",margin:new go.Margin(0,0,4,0)},new go.Binding("text","title")),e(go.TextBlock,{font:"9pt sans-serif",stroke:"#555",wrap:go.TextBlock.WrapDesiredSize,width:130},new go.Binding("text","description",(function(t){return t?t.length>50?t.substring(0,50)+"...":t:""})))))),{toolTip:e(go.Adornment,"Auto",e(go.TextBlock,{margin:4},new go.Binding("text","description")))}),this.goJsDiagram.linkTemplate=e(go.Link,{routing:go.Link.AvoidsNodes,corner:10,curve:go.Link.JumpOver,reshapable:!1,resegmentable:!1,relinkableFrom:!1,relinkableTo:!1,selectionAdorned:!1},e(go.Shape,{strokeWidth:2,stroke:"#555"}),e(go.Shape,{toArrow:"Standard",fill:"#555",stroke:null,scale:1.5})),this.diagramInitialized=!0,!0}catch(t){return console.error("GoJS: Error during diagram initialization:",t),!1}},updateGoJsModel:function(){if("undefined"==typeof go)return!1;if(!(this.goJsDiagram&&this.diagramInitialized||(this.initAttempts=0,this.initGoJsDiagram())))return setTimeout((()=>this.attemptDiagramInitialization()),500),!1;if(!this.goJsDiagram)return!1;if(!this.stages||0===this.stages.length){try{const t=new go.GraphLinksModel([],[]);this.goJsDiagram.model=t,this.goJsDiagram.requestUpdate()}catch(t){}return!0}try{const t=[];this.stages.forEach((e=>{e&&e.id&&t.push({key:e.id,title:e.title||"Untitled stage",description:e.description||"",isPublished:!1,color:e.color||"#cccccc"})}));const e=[];this.relations.forEach((t=>{t&&t.sourceStageId&&t.targetStageId&&e.push({from:t.sourceStageId,to:t.targetStageId})}));const i=new go.GraphLinksModel;return i.nodeKeyProperty="key",i.linkFromKeyProperty="from",i.linkToKeyProperty="to",i.nodeDataArray=t,i.linkDataArray=e,this.goJsDiagram.model=i,this.goJsDiagram.requestUpdate(),this.goJsDiagram.layout&&(this.goJsDiagram.layout.invalidateLayout(),this.goJsDiagram.layoutDiagram()),!0}catch(t){return console.error("GoJS: Error updating model:",t),!1}},load:function(t){var e=this;t&&(e.id=t,fetch(piranha.baseUrl+"manager/api/workflow/"+t).then((function(t){if(!t.ok)throw new Error("Response status: "+t.status);return t.json()})).then((function(t){e.bind(t),e.initAttempts=0})).catch((function(t){console.log("Error loading workflow:",t),piranha.notifications.push({body:"Failed to load workflow. Please try again.",type:"danger",hide:!0})}))),fetch(this.rolesUrl).then((t=>t.json())).then((t=>{this.availableRoles=t})).catch((t=>{console.error("Error loading roles:",t)}))},create:function(){this.id=null,this.title="",this.description="",this.stages=[],this.relations=[],this.loading=!1,fetch(this.rolesUrl).then((t=>t.json())).then((t=>{this.availableRoles=t,this.$nextTick((()=>{this.initAttempts=0,this.attemptDiagramInitialization()}))})).catch((t=>{console.error("Error loading roles:",t)}))},save:function(){var t=this;if(""!==t.title)if(0!==t.stages.length){for(var e=0;e<t.stages.length;e++)if(!t.stages[e].title)return void piranha.notifications.push({body:"Please enter a title for all stages",type:"danger",hide:!0});var i=t.stages.map((function(t){return t.title.trim().toLowerCase()})),a=new Set(i);if(i.length===a.size){var s=t.stages.find((function(t){return"draft"===t.title.trim().toLowerCase()}));if(s)for(e=0;e<t.stages.length;e++){var o=t.stages[e];if(o.id!==s.id)if(t.relations.some((function(t){return t.sourceStageId===o.id&&t.targetStageId===s.id})))if(!t.isReachable(s.id,o.id,t.relations))return void piranha.notifications.push({body:"Stage '"+o.title+"' points to 'Draft'. For the workflow to be valid, 'Draft' must have a path (direct or indirect) back to '"+o.title+"'.",type:"danger",hide:!0})}t.loading=!0;var n={id:t.id,title:t.title,description:t.description,stages:t.stages.map((function(t,e){return{id:t.id,title:t.title,description:t.description,sortOrder:e+1,color:t.color||"#cccccc",roles:(t.roleIds||[]).map((function(t){return{roleId:t}}))}})),relations:t.relations.map((function(t){return{sourceStageId:t.sourceStageId,targetStageId:t.targetStageId}}))};fetch(t.saveUrl,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then((function(t){return t.ok?t.json():t.json().then((function(t){throw t}))})).then((function(e){t.id=e.id,t.originalTitle=e.title,piranha.notifications.push({body:"The workflow has been saved",type:"success",hide:!0}),t.loading=!1,n.id||(window.location=piranha.baseUrl+"manager/workflow/edit/"+e.id)})).catch((function(e){console.log("Error saving workflow:",e),piranha.notifications.push({body:e.body||"An error occurred while saving the workflow",type:"danger",hide:!0}),t.loading=!1}))}else piranha.notifications.push({body:"Stage titles must be unique. Please ensure no two stages have the same name.",type:"danger",hide:!0})}else piranha.notifications.push({body:"Please add at least one stage to the workflow",type:"danger",hide:!0});else piranha.notifications.push({body:"Please enter a title for the workflow",type:"danger",hide:!0})},isReachable:function(t,e,i){if(t===e)return!0;var a=[t],s=new Set;for(s.add(t);a.length>0;)for(var o=a.shift(),n=i.filter((function(t){return t.sourceStageId===o})).map((function(t){return t.targetStageId})),r=0;r<n.length;r++){var l=n[r];if(l===e)return!0;s.has(l)||(s.add(l),a.push(l))}return!1},addStage:function(){if(this.stages.length>0&&this.stages[this.stages.length-1].isImmutable){const t=this.stages.length-1;this.stages.splice(t,0,{id:piranha.utils.generateId(),title:"",description:"",sortOrder:t+1,color:"#cccccc",roleIds:[],isImmutable:!1});for(let e=t+1;e<this.stages.length;e++)this.stages[e].sortOrder=e+1}else this.stages.push({id:piranha.utils.generateId(),title:"",description:"",sortOrder:this.stages.length+1,color:"#cccccc",roleIds:[],isImmutable:!1});this.$nextTick((()=>{this.updateGoJsModel()}))},removeStage:function(t){const e=this.stages[t];e.isImmutable?piranha.notifications.push({body:"This stage cannot be deleted.",type:"danger",hide:!0}):(this.stages.splice(t,1),this.relations=this.relations.filter((function(t){return t.sourceStageId!==e.id&&t.targetStageId!==e.id})),this.$nextTick((()=>{this.updateGoJsModel()})))},moveStageUp:function(t){if(t>0&&!this.stages[t].isImmutable&&!this.stages[t-1].isImmutable){const e=this.stages.splice(t,1)[0];this.stages.splice(t-1,0,e),this.$nextTick((()=>{this.updateGoJsModel()}))}},moveStageDown:function(t){if(t<this.stages.length-1&&!this.stages[t].isImmutable&&!this.stages[t+1].isImmutable){const e=this.stages.splice(t,1)[0];this.stages.splice(t+1,0,e),this.$nextTick((()=>{this.updateGoJsModel()}))}},getOtherStages:function(t){return this.stages.filter((function(e){return e.id!==t}))},canTransitionTo:function(t,e){return this.relations.some((function(i){return i.sourceStageId===t&&i.targetStageId===e}))},isRoleEditingDisabled:function(t){if(!t.isImmutable)return!1;return!!(this.stages.length>0&&this.stages[this.stages.length-1].id===t.id)},toggleStageRole:function(t,e,i){if(this.isRoleEditingDisabled(t)){i.preventDefault();var a=i.target,s=t.roleIds&&t.roleIds.includes(e);a.checked!==s&&(a.checked=s)}else i.target.checked?t.roleIds.includes(e)||t.roleIds.push(e):t.roleIds=t.roleIds.filter((function(t){return t!==e}))},selectAllRoles:function(t){if(!this.isRoleEditingDisabled(t)){this.availableRoles.forEach((function(e){t.roleIds.includes(e.id)||t.roleIds.push(e.id)}))}},deselectAllRoles:function(t){this.isRoleEditingDisabled(t)||(t.roleIds=[])},isRelationEditingDisabled:function(t){if(!t.isImmutable)return!1;return!!(this.stages.length>0&&this.stages[this.stages.length-1].id===t.id)},toggleStageRelation:function(t,e,i){const a=this.stages.find((e=>e.id===t));if(this.isRelationEditingDisabled(a)){i.preventDefault();var s=i.target,o=this.canTransitionTo(t,e);return s.checked!==o&&(s.checked=o),void piranha.notifications.push({body:"Relations for this immutable stage cannot be modified.",type:"warning",hide:!0})}i.target.checked?this.canTransitionTo(t,e)||this.relations.push({sourceStageId:t,targetStageId:e}):this.relations=this.relations.filter((function(i){return!(i.sourceStageId===t&&i.targetStageId===e)})),this.$nextTick((()=>{this.updateGoJsModel()}))},truncateDescription:function(t,e){return t?t.length>e?t.substring(0,e)+"...":t:""},onStageColorChange:function(t,e){t.isImmutable?e.preventDefault():(t.color=e.target.value,this.$nextTick((()=>{this.updateGoJsModel()})))}},computed:{hasStages:function(){return this.stages&&this.stages.length>0}},updated:function(){this.$nextTick((()=>{this.loading||this.diagramInitialized||!document.getElementById("workflowDiagramDiv")?this.diagramInitialized&&this.goJsDiagram&&this.updateGoJsModel():this.attemptDiagramInitialization()}))},mounted:function(){this.$nextTick((()=>{this.initAttempts=0,this.attemptDiagramInitialization()}))}});