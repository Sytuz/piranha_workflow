piranha.workflow=new Vue({el:"#workflow",data:{items:[],loading:!0,loadingFailed:!1,selectedWorkflow:null,searchTerm:"",goJsDiagram:null,newWorkflowTitle:"",newWorkflowDescription:""},computed:{filteredItems:function(){if(!this.searchTerm)return this.items;const e=this.searchTerm.toLowerCase();return this.items.filter((function(o){return o.title.toLowerCase().includes(e)||o.description&&o.description.toLowerCase().includes(e)}))}},methods:{formatDate:function(e){if(!e)return"";try{var o=new Date(e);return("0"+o.getDate()).slice(-2)+"/"+("0"+(o.getMonth()+1)).slice(-2)+"/"+o.getFullYear()}catch(o){return console.warn("Could not parse date:",e),e}},initGoJsDiagram:function(){if(!this.$refs.goJsDiagramDiv)return void(this.goJsDiagram&&(console.warn("GoJS init: Target div (goJsDiagramDiv) not found in refs, but a GoJS Diagram instance exists. Cleaning up old instance."),this.goJsDiagram.div=null,this.goJsDiagram=null));if(this.goJsDiagram){if(this.goJsDiagram.div===this.$refs.goJsDiagramDiv)return;console.warn("GoJS init: GoJS Diagram instance exists but is attached to an old DOM element. Re-initializing on the new div."),this.goJsDiagram.div=null,this.goJsDiagram=null}if("undefined"==typeof go)return void console.error("GoJS library is not loaded.");this.$refs.goJsDiagramDiv.offsetHeight<10&&(console.warn("GoJS init (pre-create): goJsDiagramDiv has no significant height. Forcing height.",this.$refs.goJsDiagramDiv.offsetHeight),this.$refs.goJsDiagramDiv.style.height="400px"),console.log("GoJS init: Initializing new Diagram instance. Div height now:",this.$refs.goJsDiagramDiv.offsetHeight);const e=go.GraphObject.make;this.goJsDiagram=e(go.Diagram,this.$refs.goJsDiagramDiv,{initialContentAlignment:go.Spot.Center,initialScale:.95,layout:e(go.LayeredDigraphLayout,{direction:0,layerSpacing:50,columnSpacing:30}),"undoManager.isEnabled":!1,"animationManager.isEnabled":!1,allowMove:!1,allowCopy:!1,allowDelete:!1,allowInsert:!1}),this.goJsDiagram.nodeTemplate=e(go.Node,"Auto",{locationSpot:go.Spot.Center,fromSpot:go.Spot.RightCenter,toSpot:go.Spot.LeftCenter,selectionObjectName:"PANEL",toolTip:e(go.Adornment,"Auto",e(go.TextBlock,{margin:4},new go.Binding("text","description")))},new go.Binding("layerName","isPublished",(function(e){return e?"Foreground":""})),e(go.Shape,"RoundedRectangle",{fill:"white",stroke:"#BBB",strokeWidth:1,portId:""},new go.Binding("fill","isPublished",(function(e){return e?"#E6FFED":"#FFFFFF"})),new go.Binding("stroke","isPublished",(function(e){return e?"#4CAF50":"#BBB"})),new go.Binding("strokeWidth","isPublished",(function(e){return e?2:1}))),e(go.Panel,"Vertical",{margin:10,defaultAlignment:go.Spot.Left},e(go.TextBlock,{font:"bold 10pt sans-serif",stroke:"#333",margin:new go.Margin(0,0,4,0)},new go.Binding("text","title")),e(go.TextBlock,{font:"9pt sans-serif",stroke:"#555",wrap:go.TextBlock.WrapDesiredSize,width:130},new go.Binding("text","description",(function(e){return piranha.workflow.truncateDescription(e,50)}))))),this.goJsDiagram.linkTemplate=e(go.Link,{routing:go.Link.AvoidsNodes,corner:10,curve:go.Link.JumpOver,reshapable:!1,resegmentable:!1,relinkableFrom:!1,relinkableTo:!1,selectionAdorned:!1},e(go.Shape,{strokeWidth:2,stroke:"#555"}),e(go.Shape,{toArrow:"Standard",fill:"#555",stroke:null,scale:1.5}))},updateGoJsModel:function(){if(!this.goJsDiagram)return void console.error("GoJS updateGoJsModel: Diagram instance is not available. initGoJsDiagram might have failed or was not called when the div was ready.");if(!this.selectedWorkflow||!this.selectedWorkflow.stages||0===this.selectedWorkflow.stages.length)return console.log("GoJS updateGoJsModel: No selected workflow or no stages, clearing model."),this.goJsDiagram.model=new go.GraphLinksModel([],[]),void this.goJsDiagram.requestUpdate();const e=(this.selectedWorkflow.stages||[]).map((e=>({key:e.id,title:e.title,description:e.description,isPublished:e.isPublished}))),o=(this.selectedWorkflow.relations||[]).map((e=>({from:e.sourceStageId,to:e.targetStageId})));console.log("GoJS updateGoJsModel: Nodes:",e.length,"Links:",o.length,"for workflow:",this.selectedWorkflow.id,"Enabled:",this.selectedWorkflow.isEnabled),this.goJsDiagram.model=new go.GraphLinksModel(e,o),this.goJsDiagram.requestUpdate()},load:function(){var e=this;return e.loading=!0,fetch(piranha.baseUrl+"manager/api/workflow/list").then((function(e){return e.json()})).then((function(o){if(e.items=o,e.filteredItems&&e.filteredItems.length>0){var t=!1;e.selectedWorkflow&&(t=e.filteredItems.some((o=>o.id===e.selectedWorkflow.id))),e.selectedWorkflow&&t||(e.selectedWorkflow=e.filteredItems[0])}else e.selectedWorkflow=null;return e.loading=!1,e.loadingFailed=!1,e.$nextTick((()=>{e.selectedWorkflow&&e.selectedWorkflow.stages&&e.selectedWorkflow.stages.length>0?(e.initGoJsDiagram(),e.updateGoJsModel()):e.goJsDiagram&&e.updateGoJsModel()})),o})).catch((function(o){console.error("Error loading workflows:",o),e.loading=!1,e.loadingFailed=!0,e.selectedWorkflow=null,e.goJsDiagram&&(e.goJsDiagram.model=new go.GraphLinksModel([],[]))}))},selectWorkflow:function(e){this.selectedWorkflow=e,this.$nextTick((()=>{this.selectedWorkflow&&this.selectedWorkflow.stages&&this.selectedWorkflow.stages.length>0?(this.initGoJsDiagram(),this.updateGoJsModel()):this.goJsDiagram&&this.updateGoJsModel()}))},truncateDescription:function(e,o){return e?e.length>o?e.substring(0,o)+"...":e:""},retry:function(){this.load()},toggleEnabled:function(e){var o=this,t=e.isEnabled?"Disable":"Enable",i=t+" Workflow",n="Are you sure you want to "+t.toLowerCase()+" the workflow '"+e.title+"'?";if(e.isEnabled||o.items.some((e=>e.isDefault))){if(e.isEnabled&&e.isDefault&&0===o.items.filter((o=>o.isEnabled&&o.id!==e.id)).length)return void piranha.notifications.push({body:"Cannot disable the last enabled default workflow.",type:"warning",hide:!0})}else n+=" This will also set it as the default workflow as no other default is set.";piranha.alert.confirmThis(i,n,(function(){fetch(piranha.baseUrl+"manager/api/workflow/"+e.id+"/toggle-enabled",{method:"POST",headers:{"Content-Type":"application/json"}}).then((function(e){return e.ok?e.json():e.json().then((function(e){throw e}))})).then((function(e){piranha.notifications.push({body:"Workflow '"+e.title+"' has been "+(e.isEnabled?"enabled":"disabled")+".",type:"success",hide:!0}),o.load().then((()=>{const t=o.items.find((o=>o.id===e.id));t?o.selectWorkflow(t):o.filteredItems.length>0?o.selectWorkflow(o.filteredItems[0]):(o.selectedWorkflow=null,o.updateGoJsModel())}))})).catch((function(e){console.error("Error toggling workflow enabled state:",e),piranha.notifications.push({body:e.body||"Failed to "+t.toLowerCase()+" workflow.",type:"danger",hide:!0})}))}))},createWorkflow:function(){var e=this;if(e.newWorkflowTitle.trim()){var o={title:e.newWorkflowTitle,description:e.newWorkflowDescription};fetch(piranha.baseUrl+"manager/api/workflow/create-standard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).then((function(e){return e.ok?e.json():e.json().then((function(e){throw e}))})).then((function(o){piranha.notifications.push({body:"Workflow '"+o.title+"' created successfully.",type:"success",hide:!0}),e.newWorkflowTitle="",e.newWorkflowDescription="","undefined"!=typeof $&&$("#workflowModal").modal&&$("#workflowModal").modal("hide"),e.load().then((function(){var t=e.items.find((function(e){return e.id===o.id}));t&&e.selectWorkflow(t)}))})).catch((function(e){console.error("Error creating workflow:",e),piranha.notifications.push({body:e.body||"Failed to create workflow. Please try again.",type:"danger",hide:!0})}))}else piranha.notifications.push({body:"Title is required for the new workflow.",type:"danger",hide:!0})},remove:function(e){var o=this;piranha.alert.confirmThis("Delete Workflow","Are you sure you want to delete this workflow?",(function(){fetch(piranha.baseUrl+"manager/api/workflow/delete/"+e,{method:"DELETE"}).then((function(e){return e.json()})).then((function(t){var i=o.items.length;o.items=o.items.filter((o=>o.id!==e)),o.selectedWorkflow&&o.selectedWorkflow.id===e?o.selectedWorkflow=o.filteredItems.length>0?o.filteredItems[0]:null:i>o.items.length&&o.filteredItems.length>0&&!o.selectedWorkflow?o.selectedWorkflow=o.filteredItems[0]:0===o.filteredItems.length&&(o.selectedWorkflow=null),o.$nextTick((()=>{o.selectedWorkflow&&o.selectedWorkflow.stages&&o.selectedWorkflow.stages.length>0?(o.initGoJsDiagram(),o.updateGoJsModel()):o.goJsDiagram&&o.updateGoJsModel()})),piranha.notifications.push({type:"success",body:"The workflow has been deleted"})})).catch((function(e){console.error("Error deleting workflow:",e),piranha.notifications.push({type:"danger",body:"Something went wrong deleting the workflow"})}))}))}},watch:{},mounted:function(){piranha.permissions&&"function"==typeof piranha.permissions.load?piranha.permissions.load((()=>{this.load()})):this.load()},beforeDestroy:function(){this.goJsDiagram&&(this.goJsDiagram.div=null,this.goJsDiagram=null)}}),piranha.utils||(piranha.utils={generateId:function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}});