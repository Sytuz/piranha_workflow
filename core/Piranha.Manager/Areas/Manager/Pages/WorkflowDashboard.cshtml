@page "~/manager/workflow-dashboard"
@model Piranha.Manager.Areas.Manager.Pages.WorkflowDashboardModel
@inject ManagerLocalizer Localizer
@{
    ViewBag.Title = Localizer.General["Workflow Dashboard"];
    ViewBag.MenuItem = "WorkflowDashboard";
}
@section script
{
    <script src="~/manager/assets/js/piranha.components.min.js?v=@Piranha.Utils.GetAssemblyVersionHash(typeof(Piranha.Manager.Module).Assembly)"></script>
    <script src="~/manager/assets/js/piranha.workflowdashboard.min.js?v=@Piranha.Utils.GetAssemblyVersionHash(typeof(Piranha.Manager.Module).Assembly)"></script>
}

<div id="workflow-dashboard">
    <div class="top">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">@Localizer.Menu["Content"]</li>
                <li class="breadcrumb-item active" aria-current="page">@Localizer.General["Workflow Dashboard"]</li>
            </ol>
        </nav>

        <div class="container-fluid">
            <div class="top-nav">
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-secondary" :class="{ 'active': activeTab === 'overview' }" v-on:click="setActiveTab('overview')">
                        <i class="fas fa-chart-pie"></i> @Localizer.General["Overview"]
                    </button>
                    <button class="btn btn-outline-secondary" :class="{ 'active': activeTab === 'analytics' }" v-on:click="setActiveTab('analytics')">
                        <i class="fas fa-chart-line"></i> @Localizer.General["Analytics"]
                    </button>
                    <button class="btn btn-outline-secondary" :class="{ 'active': activeTab === 'changes' }" v-on:click="setActiveTab('changes')">
                        <i class="fas fa-history"></i> @Localizer.General["Change History"]
                    </button>
                </div>
                <button v-if="loading" class="btn btn-outline-primary" disabled>
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    Loading...
                </button>
                <button v-else class="btn btn-primary btn-labeled" v-on:click="refreshData">
                    <i class="fas fa-sync"></i> @Localizer.General["Refresh"]
                </button>
            </div>
        </div>
    </div>

    <div class="container-fluid app" :class="{ ready: !loading }">
        <!-- Loading indicator -->
        <div class="text-center py-5" v-if="loading && !overview">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading workflow dashboard...</p>
        </div>

        <!-- Error state -->
        <div class="alert alert-danger" v-if="error">
            <h5><i class="fas fa-exclamation-triangle"></i> Error loading dashboard</h5>
            <p>{{ error }}</p>
            <button v-on:click="refreshData" class="btn btn-warning">
                <i class="fas fa-sync"></i> Retry
            </button>
        </div>

        <!-- Overview Tab -->
        <div v-if="activeTab === 'overview' && overview" class="dashboard-overview">
            <!-- Key Metrics Cards -->
            <div class="row mb-4">
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card dashboard-metric-card border-primary">
                        <div class="card-body text-center">
                            <div class="metric-icon text-primary mb-2">
                                <i class="fas fa-project-diagram fa-2x"></i>
                            </div>
                            <h3 class="metric-value text-primary">{{ overview.totalWorkflows }}</h3>
                            <p class="metric-label text-muted mb-0">Total Workflows</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card dashboard-metric-card border-info">
                        <div class="card-body text-center">
                            <div class="metric-icon text-info mb-2">
                                <i class="fas fa-file-alt fa-2x"></i>
                            </div>
                            <h3 class="metric-value text-info">{{ overview.totalContentInWorkflow }}</h3>
                            <p class="metric-label text-muted mb-0">Content in Workflow</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card dashboard-metric-card border-warning">
                        <div class="card-body text-center">
                            <div class="metric-icon text-warning mb-2">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                            <h3 class="metric-value text-warning">{{ overview.pendingApproval }}</h3>
                            <p class="metric-label text-muted mb-0">Pending Approval</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card dashboard-metric-card border-success">
                        <div class="card-body text-center">
                            <div class="metric-icon text-success mb-2">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                            <h3 class="metric-value text-success">{{ overview.recentlyApproved }}</h3>
                            <p class="metric-label text-muted mb-0">Recently Approved</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Stage Distribution -->
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-pie"></i> Stage Distribution
                            </h5>
                        </div>
                        <div class="card-body">
                            <div v-if="overview.stageDistribution && overview.stageDistribution.length > 0">
                                <div v-for="stage in overview.stageDistribution" class="stage-item mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="stage-name">{{ stage.stageName }}</span>
                                        <span class="badge badge-secondary">{{ stage.count }}</span>
                                    </div>
                                    <div class="stage-workflow">
                                        <small class="text-muted">{{ stage.workflowName }}</small>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar" role="progressbar" 
                                             :style="{ width: getStagePercentage(stage.count) + '%' }"
                                             :aria-valuenow="stage.count" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="text-center text-muted py-4">
                                <i class="fas fa-chart-pie fa-3x mb-3 opacity-50"></i>
                                <p>No stage data available</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-history"></i> Recent Activity
                            </h5>
                        </div>
                        <div class="card-body">
                            <div v-if="overview.recentActivity && overview.recentActivity.length > 0" class="activity-list">
                                <div v-for="activity in overview.recentActivity" class="activity-item border-bottom pb-3 mb-3">
                                    <div class="d-flex align-items-start">
                                        <div class="activity-icon me-3">
                                            <i class="fas fa-circle-dot text-primary"></i>
                                        </div>
                                        <div class="activity-content flex-grow-1">
                                            <div class="activity-title">
                                                <strong>{{ activity.contentTitle }}</strong>
                                            </div>
                                            <div class="activity-details">
                                                <span class="badge badge-light me-2">{{ activity.contentType }}</span>
                                                <small class="text-muted">{{ activity.action }} by {{ activity.user }}</small>
                                            </div>
                                            <div class="activity-workflow">
                                                <small class="text-muted">
                                                    {{ activity.fromStage }} → {{ activity.toStage }}
                                                </small>
                                            </div>
                                            <div class="activity-time">
                                                <small class="text-muted">{{ formatDateTime(activity.timestamp) }}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="text-center text-muted py-4">
                                <i class="fas fa-history fa-3x mb-3 opacity-50"></i>
                                <p>No recent activity</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div v-if="activeTab === 'analytics' && analytics" class="dashboard-analytics">
            <div class="row mb-4">
                <!-- Time Range Selector -->
                <div class="col-12 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5 class="card-title mb-0">Analytics Overview</h5>
                                </div>
                                <div class="col-md-6 text-md-right">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm" 
                                                :class="analyticsTimeRange === 7 ? 'btn-primary' : 'btn-outline-secondary'"
                                                v-on:click="setAnalyticsTimeRange(7)">7 Days</button>
                                        <button type="button" class="btn btn-sm" 
                                                :class="analyticsTimeRange === 30 ? 'btn-primary' : 'btn-outline-secondary'"
                                                v-on:click="setAnalyticsTimeRange(30)">30 Days</button>
                                        <button type="button" class="btn btn-sm" 
                                                :class="analyticsTimeRange === 90 ? 'btn-primary' : 'btn-outline-secondary'"
                                                v-on:click="setAnalyticsTimeRange(90)">90 Days</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <!-- Key Analytics Metrics -->
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card dashboard-metric-card border-success">
                        <div class="card-body text-center">
                            <div class="metric-icon text-success mb-2">
                                <i class="fas fa-check-double fa-2x"></i>
                            </div>
                            <h3 class="metric-value text-success">{{ analytics.completedWorkflows }}</h3>
                            <p class="metric-label text-muted mb-0">Completed Workflows</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card dashboard-metric-card border-info">
                        <div class="card-body text-center">
                            <div class="metric-icon text-info mb-2">
                                <i class="fas fa-percentage fa-2x"></i>
                            </div>
                            <h3 class="metric-value text-info">{{ analytics.approvalRate.toFixed(1) }}%</h3>
                            <p class="metric-label text-muted mb-0">Approval Rate</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card dashboard-metric-card border-warning">
                        <div class="card-body text-center">
                            <div class="metric-icon text-warning mb-2">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                            <h3 class="metric-value text-warning">{{ analytics.averageProcessingTimeHours.toFixed(1) }}h</h3>
                            <p class="metric-label text-muted mb-0">Avg Processing Time</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card dashboard-metric-card border-danger">
                        <div class="card-body text-center">
                            <div class="metric-icon text-danger mb-2">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                            </div>
                            <h3 class="metric-value text-danger">{{ getBottleneckCount() }}</h3>
                            <p class="metric-label text-muted mb-0">Bottlenecks</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts and Tables Row -->
            <div class="row">
                <!-- Daily Activity Chart -->
                <div class="col-md-8 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-line"></i> Daily Activity
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="dailyActivityChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content Type Distribution -->
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-pie"></i> Content Types
                            </h5>
                        </div>
                        <div class="card-body">
                            <div v-if="analytics.contentTypeStats && analytics.contentTypeStats.length > 0">
                                <div v-for="stat in analytics.contentTypeStats" class="content-type-item mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span>{{ stat.contentType }}</span>
                                        <span class="badge badge-primary">{{ stat.count }}</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar" role="progressbar" 
                                             :style="{ width: stat.percentage + '%' }"
                                             :aria-valuenow="stat.percentage" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                    <small class="text-muted">Avg: {{ stat.averageProcessingTimeHours.toFixed(1) }}h</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workflow Performance Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-table"></i> Workflow Performance
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Workflow</th>
                                            <th>Completion Rate</th>
                                            <th>Avg Processing Time</th>
                                            <th>Total Processed</th>
                                            <th>Active Items</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="metric in analytics.workflowMetrics" :key="metric.workflowId">
                                            <td>{{ metric.workflowName }}</td>
                                            <td>
                                                <span class="badge" :class="getCompletionRateBadgeClass(metric.completionRate)">
                                                    {{ metric.completionRate.toFixed(1) }}%
                                                </span>
                                            </td>
                                            <td>{{ metric.averageProcessingTimeHours.toFixed(1) }}h</td>
                                            <td>{{ metric.totalItemsProcessed }}</td>
                                            <td>{{ metric.activeItems }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Change History Tab -->
        <div v-if="activeTab === 'changes'" class="dashboard-changes">
            <!-- Filters -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-filter"></i> Filters
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label for="contentTypeFilter" class="form-label">Content Type</label>
                                    <select id="contentTypeFilter" class="form-control" v-model="changeFilters.contentType" v-on:change="loadChangeHistory">
                                        <option value="">All Types</option>
                                        <option value="Page">Pages</option>
                                        <option value="Post">Posts</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="changeTypeFilter" class="form-label">Change Type</label>
                                    <select id="changeTypeFilter" class="form-control" v-model="changeFilters.changeType" v-on:change="loadChangeHistory">
                                        <option value="">All Changes</option>
                                        <option value="Created">Created</option>
                                        <option value="Updated">Updated</option>
                                        <option value="Approved">Approved</option>
                                        <option value="Rejected">Rejected</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="userFilter" class="form-label">User</label>
                                    <input type="text" id="userFilter" class="form-control" placeholder="Filter by user..." 
                                           v-model="changeFilters.user" v-on:input="debounceLoadChangeHistory">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div>
                                        <button class="btn btn-outline-secondary" v-on:click="clearChangeFilters">
                                            <i class="fas fa-times"></i> Clear Filters
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Change History Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-history"></i> Change History
                            </h5>
                            <span class="badge badge-info" v-if="changeHistory">
                                {{ changeHistory.totalCount }} total changes
                            </span>
                        </div>
                        <div class="card-body">
                            <!-- Loading state for changes -->
                            <div v-if="loadingChanges" class="text-center py-4">
                                <div class="spinner-border" role="status">
                                    <span class="sr-only">Loading changes...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading change history...</p>
                            </div>

                            <!-- Changes table -->
                            <div v-else-if="changeHistory && changeHistory.items && changeHistory.items.length > 0">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Content</th>
                                                <th>Type</th>
                                                <th>Change</th>
                                                <th>User</th>
                                                <th>Workflow</th>
                                                <th>Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="change in changeHistory.items" :key="change.id">
                                                <td>
                                                    <strong>{{ change.contentTitle }}</strong>
                                                    <br>
                                                    <small class="text-muted">{{ change.description }}</small>
                                                </td>
                                                <td>
                                                    <span class="badge" :class="getContentTypeBadgeClass(change.contentType)">
                                                        {{ change.contentType }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge" :class="getChangeTypeBadgeClass(change.changeType)">
                                                        {{ change.changeType }}
                                                    </span>
                                                    <br>
                                                    <small class="text-muted">
                                                        {{ change.previousStage }} → {{ change.currentStage }}
                                                    </small>
                                                </td>
                                                <td>{{ change.user }}</td>
                                                <td>{{ change.workflowName }}</td>
                                                <td>{{ formatDateTime(change.timestamp) }}</td>
                                                <td>
                                                    <button v-on:click="viewChangeRequestDetails(change.id)" class="btn btn-sm btn-info me-1" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <a v-if="change.editUrl" :href="change.editUrl" class="btn btn-sm btn-outline-primary" title="Edit">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination -->
                                <nav v-if="changeHistory.totalPages > 1" aria-label="Change history pagination">
                                    <ul class="pagination justify-content-center">
                                        <li class="page-item" :class="{ disabled: changeHistory.currentPage <= 1 }">
                                            <button class="page-link" v-on:click="changeHistoryPage(changeHistory.currentPage - 1)" :disabled="changeHistory.currentPage <= 1">
                                                Previous
                                            </button>
                                        </li>
                                        <li v-for="page in getPageNumbers()" :key="page" class="page-item" :class="{ active: page === changeHistory.currentPage }">
                                            <button class="page-link" v-on:click="changeHistoryPage(page)">{{ page }}</button>
                                        </li>
                                        <li class="page-item" :class="{ disabled: changeHistory.currentPage >= changeHistory.totalPages }">
                                            <button class="page-link" v-on:click="changeHistoryPage(changeHistory.currentPage + 1)" :disabled="changeHistory.currentPage >= changeHistory.totalPages">
                                                Next
                                            </button>
                                        </li>
                                    </ul>
                                </nav>
                            </div>

                            <!-- Empty state -->
                            <div v-else class="text-center text-muted py-5">
                                <i class="fas fa-history fa-3x mb-3 opacity-50"></i>
                                <h5>No changes found</h5>
                                <p>Try adjusting your filters or check back later for new activity.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Request Details Modal -->
<div id="changeRequestDetailsModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="changeRequestDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changeRequestDetailsModalLabel">
                    <i class="fas fa-file-alt"></i> Change Request Details
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Loading state -->
                <div v-if="loadingDetails" class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading details...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading change request details...</p>
                </div>

                <!-- Error state -->
                <div v-if="detailsError" class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle"></i> Error Loading Details</h6>
                    <p>{{ detailsError }}</p>
                    <button v-on:click="loadChangeRequestDetails(selectedChangeRequestId)" class="btn btn-warning btn-sm">
                        <i class="fas fa-sync"></i> Retry
                    </button>
                </div>

                <!-- Details content -->
                <div v-if="changeRequestDetails && !loadingDetails && !detailsError">
                    <!-- Header Info -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <h4>{{ changeRequestDetails.changeRequest.title }}</h4>
                            <p class="text-muted mb-2">{{ changeRequestDetails.content.contentType }} • Created {{ formatDateTime(changeRequestDetails.changeRequest.createdAt) }}</p>
                            <div class="d-flex align-items-center">
                                <span class="badge me-2" :class="getChangeStatusBadgeClass(changeRequestDetails.changeRequest.status)">
                                    {{ getChangeStatusText(changeRequestDetails.changeRequest.status) }}
                                </span>
                                <span class="text-muted">by {{ changeRequestDetails.creator.name }}</span>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-right">
                            <div class="btn-group">
                                <button v-for="action in changeRequestDetails.availableActions" 
                                        v-on:click="executeAction(action, changeRequestDetails.changeRequest.id)"
                                        :key="action.type" 
                                        class="btn btn-sm"
                                        :class="getActionButtonClass(action.type)"
                                        :disabled="!action.enabled">
                                    <i :class="action.icon"></i> {{ action.label }}
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Workflow Information -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-project-diagram"></i> Workflow Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-sm-4"><strong>Workflow:</strong></div>
                                        <div class="col-sm-8">{{ changeRequestDetails.workflow.title }}</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-4"><strong>Current Stage:</strong></div>
                                        <div class="col-sm-8">{{ changeRequestDetails.currentStage.title }}</div>
                                    </div>
                                    <div class="row" v-if="changeRequestDetails.workflow.description">
                                        <div class="col-sm-4"><strong>Description:</strong></div>
                                        <div class="col-sm-8">{{ changeRequestDetails.workflow.description }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> Content Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-sm-4"><strong>Content ID:</strong></div>
                                        <div class="col-sm-8"><code>{{ changeRequestDetails.content.id }}</code></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-4"><strong>Content Type:</strong></div>
                                        <div class="col-sm-8">{{ changeRequestDetails.content.contentType }}</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-4"><strong>Last Modified:</strong></div>
                                        <div class="col-sm-8">{{ formatDateTime(changeRequestDetails.content.lastModified) }}</div>
                                    </div>
                                    <div class="row" v-if="changeRequestDetails.content.editUrl">
                                        <div class="col-sm-4"><strong>Actions:</strong></div>
                                        <div class="col-sm-8">
                                            <a :href="changeRequestDetails.content.editUrl" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-edit"></i> Edit Content
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div v-if="changeRequestDetails.changeRequest.notes" class="row mb-4">
                        <div class="col">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-comment"></i> Notes & Comments</h6>
                                </div>
                                <div class="card-body">
                                    <div class="border p-3 bg-light">
                                        <pre class="mb-0">{{ changeRequestDetails.changeRequest.notes }}</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content Snapshot Preview -->
                    <div class="row">
                        <div class="col">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-code"></i> Content Snapshot</h6>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i> 
                                        This shows the content state captured when the change request was created.
                                    </div>
                                    <div class="border p-3 bg-light" style="max-height: 400px; overflow-y: auto;">
                                        <pre class="mb-0">{{ changeRequestDetails.contentDiff.modifiedContent }}</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <div class="btn-group" v-if="changeRequestDetails && changeRequestDetails.availableActions.length > 0">
                    <button v-for="action in changeRequestDetails.availableActions" 
                            v-on:click="executeAction(action, changeRequestDetails.changeRequest.id)"
                            :key="action.type" 
                            class="btn btn-sm"
                            :class="getActionButtonClass(action.type)"
                            :disabled="!action.enabled">
                        <i :class="action.icon"></i> {{ action.label }}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Confirmation Modal -->
<div id="actionConfirmationModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="actionConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="actionConfirmationModalLabel">
                    <i :class="pendingAction ? pendingAction.Icon : ''"></i> {{ pendingAction ? pendingAction.Label : '' }} Change Request
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div v-if="pendingAction && pendingAction.Type === 'approve'">
                    <p>Are you sure you want to approve this change request?</p>
                    <div class="form-group">
                        <label for="approvalComments">Approval Comments (Optional)</label>
                        <textarea id="approvalComments" v-model="actionData.comments" class="form-control" rows="3" 
                                  placeholder="Add any comments about the approval..."></textarea>
                    </div>
                </div>
                <div v-if="pendingAction && pendingAction.Type === 'reject'">
                    <p>Are you sure you want to reject this change request?</p>
                    <div class="form-group">
                        <label for="rejectionReason">Rejection Reason *</label>
                        <textarea id="rejectionReason" v-model="actionData.reason" class="form-control" rows="3" 
                                  placeholder="Please provide a reason for rejecting this change request..." required></textarea>
                        <div v-if="actionError" class="invalid-feedback d-block">{{ actionError }}</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" v-on:click="confirmAction" class="btn" 
                        :class="getActionButtonClass(pendingAction ? pendingAction.Type : '')"
                        :disabled="executingAction">
                    <span v-if="executingAction" class="spinner-border spinner-border-sm me-1" role="status"></span>
                    <i v-if="!executingAction && pendingAction" :class="pendingAction.Icon"></i>
                    {{ pendingAction ? pendingAction.Label : '' }}
                </button>
            </div>
        </div>
    </div>
</div>
