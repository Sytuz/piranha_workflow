@page "~/manager/workflow-dashboard"
@model Piranha.Manager.Areas.Manager.Pages.WorkflowDashboardModel
@inject ManagerLocalizer Localizer
@{
    ViewBag.Title = Localizer.General["Workflow Dashboard"];
    ViewBag.MenuItem = "WorkflowDashboard";
}
@section script
{
    <script src="~/manager/assets/js/piranha.components.min.js?v=@Piranha.Utils.GetAssemblyVersionHash(typeof(Piranha.Manager.Module).Assembly)"></script>
    <script src="~/manager/assets/js/piranha.workflowdashboard.min.js?v=@Piranha.Utils.GetAssemblyVersionHash(typeof(Piranha.Manager.Module).Assembly)"></script>
}

<div id="workflow-dashboard">
    <div class="top">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">@Localizer.Menu["Content"]</li>
                <li class="breadcrumb-item active" aria-current="page">@Localizer.General["Workflow Dashboard"]</li>
            </ol>
        </nav>

        <div class="container-fluid">
            <div class="top-nav">
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-secondary" :class="{ 'active': activeTab === 'overview' }" v-on:click="setActiveTab('overview')">
                        <i class="fas fa-chart-pie"></i> @Localizer.General["Overview"]
                    </button>
                    <button class="btn btn-outline-secondary" :class="{ 'active': activeTab === 'analytics' }" v-on:click="setActiveTab('analytics')">
                        <i class="fas fa-chart-line"></i> @Localizer.General["Analytics"]
                    </button>
                    <button class="btn btn-outline-secondary" :class="{ 'active': activeTab === 'changes' }" v-on:click="setActiveTab('changes')">
                        <i class="fas fa-history"></i> @Localizer.General["Change History"]
                    </button>
                </div>
                <button v-if="loading" class="btn btn-outline-primary" disabled>
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    Loading...
                </button>
                <button v-else class="btn btn-primary btn-labeled" v-on:click="refreshData">
                    <i class="fas fa-sync"></i> @Localizer.General["Refresh"]
                </button>
            </div>
        </div>
    </div>

    <div class="container-fluid app" :class="{ ready: !loading }">
        <!-- Loading indicator -->
        <div class="text-center py-5" v-if="loading && !overview">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading workflow dashboard...</p>
        </div>

        <!-- Error state -->
        <div class="alert alert-danger" v-if="error">
            <h5><i class="fas fa-exclamation-triangle"></i> Error loading dashboard</h5>
            <p>{{ error }}</p>
            <button v-on:click="refreshData" class="btn btn-warning">
                <i class="fas fa-sync"></i> Retry
            </button>
        </div>

        <!-- Overview Tab -->
        <div v-if="activeTab === 'overview' && overview" class="dashboard-overview">
            <!-- Key Metrics Cards -->
            <div class="row mb-4">
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card dashboard-metric-card border-primary">
                        <div class="card-body text-center">
                            <div class="metric-icon text-primary mb-2">
                                <i class="fas fa-project-diagram fa-2x"></i>
                            </div>
                            <h3 class="metric-value text-primary">{{ overview.totalWorkflows }}</h3>
                            <p class="metric-label text-muted mb-0">Total Workflows</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card dashboard-metric-card border-info">
                        <div class="card-body text-center">
                            <div class="metric-icon text-info mb-2">
                                <i class="fas fa-file-alt fa-2x"></i>
                            </div>
                            <h3 class="metric-value text-info">{{ overview.totalContentInWorkflow }}</h3>
                            <p class="metric-label text-muted mb-0">Content in Workflow</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card dashboard-metric-card border-warning">
                        <div class="card-body text-center">
                            <div class="metric-icon text-warning mb-2">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                            <h3 class="metric-value text-warning">{{ overview.pendingApproval }}</h3>
                            <p class="metric-label text-muted mb-0">Pending Approval</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card dashboard-metric-card border-success">
                        <div class="card-body text-center">
                            <div class="metric-icon text-success mb-2">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                            <h3 class="metric-value text-success">{{ overview.recentlyApproved }}</h3>
                            <p class="metric-label text-muted mb-0">Recently Approved</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Stage Distribution -->
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-pie"></i> Stage Distribution
                            </h5>
                        </div>
                        <div class="card-body">
                            <div v-if="overview.stageDistribution && overview.stageDistribution.length > 0">
                                <div v-for="stage in overview.stageDistribution" class="stage-item mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="stage-name">{{ stage.stageName }}</span>
                                        <span class="badge badge-secondary">{{ stage.count }}</span>
                                    </div>
                                    <div class="stage-workflow">
                                        <small class="text-muted">{{ stage.workflowName }}</small>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar" role="progressbar" 
                                             :style="{ width: getStagePercentage(stage.count) + '%' }"
                                             :aria-valuenow="stage.count" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="text-center text-muted py-4">
                                <i class="fas fa-chart-pie fa-3x mb-3 opacity-50"></i>
                                <p>No stage data available</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-history"></i> Recent Activity
                            </h5>
                        </div>
                        <div class="card-body">
                            <div v-if="overview.recentActivity && overview.recentActivity.length > 0" class="activity-list">
                                <div v-for="activity in overview.recentActivity" class="activity-item border-bottom pb-3 mb-3">
                                    <div class="d-flex align-items-start">
                                        <div class="activity-icon me-3">
                                            <i class="fas fa-circle-dot text-primary"></i>
                                        </div>
                                        <div class="activity-content flex-grow-1">
                                            <div class="activity-title">
                                                <strong>{{ activity.contentTitle }}</strong>
                                            </div>
                                            <div class="activity-details">
                                                <span class="badge badge-light me-2">{{ activity.contentType }}</span>
                                                <small class="text-muted">{{ activity.action }} by {{ activity.user }}</small>
                                            </div>
                                            <div class="activity-workflow">
                                                <small class="text-muted">
                                                    {{ activity.fromStage }} → {{ activity.toStage }}
                                                </small>
                                            </div>
                                            <div class="activity-time">
                                                <small class="text-muted">{{ formatDateTime(activity.timestamp) }}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="text-center text-muted py-4">
                                <i class="fas fa-history fa-3x mb-3 opacity-50"></i>
                                <p>No recent activity</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div v-if="activeTab === 'analytics' && analytics" class="dashboard-analytics">
            <div class="row mb-4">
                <!-- Time Range Selector -->
                <div class="col-12 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5 class="card-title mb-0">Analytics Overview</h5>
                                </div>
                                <div class="col-md-6 text-md-right">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm" 
                                                :class="analyticsTimeRange === 7 ? 'btn-primary' : 'btn-outline-secondary'"
                                                v-on:click="setAnalyticsTimeRange(7)">7 Days</button>
                                        <button type="button" class="btn btn-sm" 
                                                :class="analyticsTimeRange === 30 ? 'btn-primary' : 'btn-outline-secondary'"
                                                v-on:click="setAnalyticsTimeRange(30)">30 Days</button>
                                        <button type="button" class="btn btn-sm" 
                                                :class="analyticsTimeRange === 90 ? 'btn-primary' : 'btn-outline-secondary'"
                                                v-on:click="setAnalyticsTimeRange(90)">90 Days</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <!-- Key Analytics Metrics -->
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card dashboard-metric-card border-success">
                        <div class="card-body text-center">
                            <div class="metric-icon text-success mb-2">
                                <i class="fas fa-check-double fa-2x"></i>
                            </div>
                            <h3 class="metric-value text-success">{{ analytics.completedWorkflows }}</h3>
                            <p class="metric-label text-muted mb-0">Completed Workflows</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card dashboard-metric-card border-info">
                        <div class="card-body text-center">
                            <div class="metric-icon text-info mb-2">
                                <i class="fas fa-percentage fa-2x"></i>
                            </div>
                            <h3 class="metric-value text-info">{{ analytics.approvalRate.toFixed(1) }}%</h3>
                            <p class="metric-label text-muted mb-0">Approval Rate</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card dashboard-metric-card border-warning">
                        <div class="card-body text-center">
                            <div class="metric-icon text-warning mb-2">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                            <h3 class="metric-value text-warning">{{ analytics.averageProcessingTimeHours.toFixed(1) }}h</h3>
                            <p class="metric-label text-muted mb-0">Avg Processing Time</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card dashboard-metric-card border-danger">
                        <div class="card-body text-center">
                            <div class="metric-icon text-danger mb-2">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                            </div>
                            <h3 class="metric-value text-danger">{{ getBottleneckCount() }}</h3>
                            <p class="metric-label text-muted mb-0">Bottlenecks</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts and Tables Row -->
            <div class="row">
                <!-- Daily Activity Chart -->
                <div class="col-md-8 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-line"></i> Daily Activity
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="dailyActivityChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content Type Distribution -->
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-pie"></i> Content Types
                            </h5>
                        </div>
                        <div class="card-body">
                            <div v-if="analytics.contentTypeStats && analytics.contentTypeStats.length > 0">
                                <div v-for="stat in analytics.contentTypeStats" class="content-type-item mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span>{{ stat.contentType }}</span>
                                        <span class="badge badge-primary">{{ stat.count }}</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar" role="progressbar" 
                                             :style="{ width: stat.percentage + '%' }"
                                             :aria-valuenow="stat.percentage" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                    <small class="text-muted">Avg: {{ stat.averageProcessingTimeHours.toFixed(1) }}h</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workflow Performance Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-table"></i> Workflow Performance
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Workflow</th>
                                            <th>Completion Rate</th>
                                            <th>Avg Processing Time</th>
                                            <th>Total Processed</th>
                                            <th>Active Items</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="metric in analytics.workflowMetrics" :key="metric.workflowId">
                                            <td>{{ metric.workflowName }}</td>
                                            <td>
                                                <span class="badge" :class="getCompletionRateBadgeClass(metric.completionRate)">
                                                    {{ metric.completionRate.toFixed(1) }}%
                                                </span>
                                            </td>
                                            <td>{{ metric.averageProcessingTimeHours.toFixed(1) }}h</td>
                                            <td>{{ metric.totalItemsProcessed }}</td>
                                            <td>{{ metric.activeItems }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Change History Tab -->
        <div v-if="activeTab === 'changes'" class="dashboard-changes">
            <!-- Filters -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-filter"></i> Filters
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label for="contentTypeFilter" class="form-label">Content Type</label>
                                    <select id="contentTypeFilter" class="form-select" v-model="changeFilters.contentType" v-on:change="loadChangeHistory">
                                        <option value="">All Types</option>
                                        <option value="Page">Pages</option>
                                        <option value="Post">Posts</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="changeTypeFilter" class="form-label">Change Type</label>
                                    <select id="changeTypeFilter" class="form-select" v-model="changeFilters.changeType" v-on:change="loadChangeHistory">
                                        <option value="">All Changes</option>
                                        <option value="Created">Created</option>
                                        <option value="Updated">Updated</option>
                                        <option value="Approved">Approved</option>
                                        <option value="Rejected">Rejected</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="userFilter" class="form-label">User</label>
                                    <input type="text" id="userFilter" class="form-control" placeholder="Filter by user..." 
                                           v-model="changeFilters.user" v-on:input="debounceLoadChangeHistory">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div>
                                        <button class="btn btn-outline-secondary" v-on:click="clearChangeFilters">
                                            <i class="fas fa-times"></i> Clear Filters
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Change History Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-history"></i> Change History
                            </h5>
                            <span class="badge badge-info" v-if="changeHistory">
                                {{ changeHistory.totalCount }} total changes
                            </span>
                        </div>
                        <div class="card-body">
                            <!-- Loading state for changes -->
                            <div v-if="loadingChanges" class="text-center py-4">
                                <div class="spinner-border" role="status">
                                    <span class="sr-only">Loading changes...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading change history...</p>
                            </div>

                            <!-- Changes table -->
                            <div v-else-if="changeHistory && changeHistory.items && changeHistory.items.length > 0">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Content</th>
                                                <th>Type</th>
                                                <th>Change</th>
                                                <th>User</th>
                                                <th>Workflow</th>
                                                <th>Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="change in changeHistory.items" :key="change.id">
                                                <td>
                                                    <strong>{{ change.contentTitle }}</strong>
                                                    <br>
                                                    <small class="text-muted">{{ change.description }}</small>
                                                </td>
                                                <td>
                                                    <span class="badge" :class="getContentTypeBadgeClass(change.contentType)">
                                                        {{ change.contentType }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge" :class="getChangeTypeBadgeClass(change.changeType)">
                                                        {{ change.changeType }}
                                                    </span>
                                                    <br>
                                                    <small class="text-muted">
                                                        {{ change.previousStage }} → {{ change.currentStage }}
                                                    </small>
                                                </td>
                                                <td>{{ change.user }}</td>
                                                <td>{{ change.workflowName }}</td>
                                                <td>{{ formatDateTime(change.timestamp) }}</td>
                                                <td>
                                                    <a v-if="change.editUrl" :href="change.editUrl" class="btn btn-sm btn-outline-primary" title="Edit">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination -->
                                <nav v-if="changeHistory.totalPages > 1" aria-label="Change history pagination">
                                    <ul class="pagination justify-content-center">
                                        <li class="page-item" :class="{ disabled: changeHistory.currentPage <= 1 }">
                                            <button class="page-link" v-on:click="changeHistoryPage(changeHistory.currentPage - 1)" :disabled="changeHistory.currentPage <= 1">
                                                Previous
                                            </button>
                                        </li>
                                        <li v-for="page in getPageNumbers()" :key="page" class="page-item" :class="{ active: page === changeHistory.currentPage }">
                                            <button class="page-link" v-on:click="changeHistoryPage(page)">{{ page }}</button>
                                        </li>
                                        <li class="page-item" :class="{ disabled: changeHistory.currentPage >= changeHistory.totalPages }">
                                            <button class="page-link" v-on:click="changeHistoryPage(changeHistory.currentPage + 1)" :disabled="changeHistory.currentPage >= changeHistory.totalPages">
                                                Next
                                            </button>
                                        </li>
                                    </ul>
                                </nav>
                            </div>

                            <!-- Empty state -->
                            <div v-else class="text-center text-muted py-5">
                                <i class="fas fa-history fa-3x mb-3 opacity-50"></i>
                                <h5>No changes found</h5>
                                <p>Try adjusting your filters or check back later for new activity.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
