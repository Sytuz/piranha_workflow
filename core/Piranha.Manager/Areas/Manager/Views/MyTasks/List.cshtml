@model Piranha.Manager.Models.MyTasksViewModel
@{
    ViewBag.Title = "My Tasks";
    ViewBag.MenuItem = "MyTasks";
}
@section script
{
    <script src="~/manager/assets/js/piranha.mytasks.min.js?v=@Piranha.Utils.GetAssemblyVersionHash(typeof(Piranha.Manager.Module).Assembly)"></script>
    <script>
        piranha.permissions.load(function () {
            piranha.mytasks.load();
        });
    </script>
}

<div id="mytasks" class="container-fluid">
    <!-- Page Header -->
    <div class="top">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">System</li>
                <li class="breadcrumb-item active" aria-current="page">My Tasks</li>
            </ol>
        </nav>
    </div>

    <!-- Loading State -->
    <div v-if="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading your tasks...</p>
    </div>

    <!-- Main Content -->
    <div v-if="!loading">
        <!-- Filter Buttons -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="btn-group" role="group">
                    <button v-on:click="setStatus('all')" class="btn btn-sm" :class="state === 'all' ? 'btn-primary' : 'btn-outline-secondary'">
                        All Tasks
                    </button>
                    <button v-on:click="setStatus('pending')" class="btn btn-sm" :class="state === 'pending' ? 'btn-primary' : 'btn-outline-secondary'">
                        Pending
                    </button>
                    <button v-on:click="setStatus('approved')" class="btn btn-sm" :class="state === 'approved' ? 'btn-primary' : 'btn-outline-secondary'">
                        Approved
                    </button>
                    <button v-on:click="setStatus('rejected')" class="btn btn-sm" :class="state === 'rejected' ? 'btn-primary' : 'btn-outline-secondary'">
                        Rejected
                    </button>
                </div>
            </div>
            <div class="col-md-6 text-right">
                <button class="btn btn-outline-primary btn-sm" v-on:click="refreshTasks">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Tasks Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <div class="metric-icon text-primary mb-2">
                            <i class="fas fa-tasks fa-2x"></i>
                        </div>
                        <h3 class="metric-value text-primary">{{ items.length }}</h3>
                        <p class="metric-label text-muted mb-0">Total Tasks</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <div class="metric-icon text-info mb-2">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                        <h3 class="metric-value text-info">{{ filteredItems.filter(i => i.Status === 'Pending').length }}</h3>
                        <p class="metric-label text-muted mb-0">Pending Review</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <div class="metric-icon text-success mb-2">
                            <i class="fas fa-check fa-2x"></i>
                        </div>
                        <h3 class="metric-value text-success">{{ filteredItems.filter(i => i.Status === 'Approved').length }}</h3>
                        <p class="metric-label text-muted mb-0">Approved</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasks List -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list"></i> My Tasks
                </h5>
            </div>
            <div class="card-body">
                <!-- Tasks Table -->
                <div v-if="filteredItems.length > 0">
                    <div class="table-responsive">
                        <table class="table table-hover">                                <thead>
                                    <tr>
                                        <th>Content</th>
                                        <th>Type</th>
                                        <th>Workflow</th>
                                        <th>Status</th>
                                        <th>Last Modified</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="item in filteredItems" :key="item.Id">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-file-alt text-muted me-2"></i>
                                                <div>
                                                    <strong>{{ item.ContentTitle || 'Untitled' }}</strong>
                                                    <br>
                                                    <small class="text-muted">{{ item.Action }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge badge-light">{{ item.ContentType }}</span>
                                        </td>
                                        <td>{{ item.WorkflowName }}</td>
                                        <td>
                                            <span class="badge" :class="getStatusBadgeClass(item.Status)">
                                                {{ item.Status }}
                                            </span>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ formatDate(item.Timestamp) }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button 
                                                    v-if="item.Status === 'Pending'"
                                                    class="btn btn-success"
                                                    v-on:click="approveTask(item)"
                                                    title="Approve">
                                                    <i class="fas fa-check"></i> Approve
                                                </button>
                                                <button 
                                                    v-if="item.Status === 'Pending'"
                                                    class="btn btn-danger"
                                                    v-on:click="rejectTask(item)"
                                                    title="Reject">
                                                    <i class="fas fa-times"></i> Reject
                                                </button>
                                            </div>
                                            <small v-if="item.Status !== 'Pending'" class="text-muted">No actions</small>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div v-else class="text-center py-5">
                        <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No tasks found</h5>
                        <p class="text-muted">You don't have any workflow tasks assigned to you at the moment.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Confirmation Modal -->
<div class="modal fade" id="actionConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="actionConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="actionConfirmationModalLabel">{{ pendingAction ? pendingAction.label : 'Confirm Action' }}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div v-if="selectedTask">
                    <p><strong>Content:</strong> {{ selectedTask.ContentTitle }}</p>
                    <p><strong>Type:</strong> {{ selectedTask.ContentType }}</p>
                    <p><strong>Workflow:</strong> {{ selectedTask.WorkflowName }}</p>
                    
                    <div v-if="pendingAction && pendingAction.type === 'reject'" class="form-group">
                        <label for="rejectionReason">Rejection Reason <span class="text-danger">*</span></label>
                        <textarea id="rejectionReason" v-model="actionData.reason" class="form-control" rows="3" placeholder="Please provide a reason for rejection..."></textarea>
                    </div>
                    
                    <div v-if="pendingAction && pendingAction.type === 'approve'" class="form-group">
                        <label for="approvalComments">Comments (Optional)</label>
                        <textarea id="approvalComments" v-model="actionData.comments" class="form-control" rows="3" placeholder="Any additional comments..."></textarea>
                    </div>
                    
                    <div v-if="actionError" class="alert alert-danger">
                        {{ actionError }}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" v-on:click="cancelAction">Cancel</button>
                <button type="button" class="btn" 
                        :class="pendingAction && pendingAction.type === 'approve' ? 'btn-success' : 'btn-danger'"
                        v-on:click="confirmAction"
                        :disabled="executingAction">
                    <span v-if="executingAction" class="spinner-border spinner-border-sm me-1" role="status"></span>
                    {{ pendingAction ? pendingAction.label : 'Confirm' }}
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.metric-icon {
    font-size: 1.2rem;
}

.metric-value {
    font-weight: bold;
    margin: 0;
}

.metric-label {
    font-size: 0.9rem;
}

.btn-group-sm .btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.table td {
    vertical-align: middle;
}

.badge {
    font-size: 0.75rem;
}
</style>
